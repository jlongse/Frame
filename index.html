<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frame ‚Äî Mood Board</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@300;400;500&family=Syne:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a;
  --s1:#111;
  --s2:#181818;
  --s3:#202020;
  --s4:#282828;
  --b1:#1e1e1e;
  --b2:#2a2a2a;
  --b3:#383838;
  --t1:#ede8e0;
  --t2:#8c867e;
  --t3:#4a4642;
  --t4:#2a2724;
  --acc:#d4a85a;
  --acc2:rgba(212,168,90,0.12);
  --acc3:rgba(212,168,90,0.25);
  --comp:#6b92b0;
  --luz:#d4a85a;
  --col:#7db8a0;
  --red:#b06060;
  --green:#7db8a0;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--t1);font-family:'Syne',sans-serif;font-size:13px;display:flex;flex-direction:column;}

/* GRAIN */
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");pointer-events:none;z-index:9998;opacity:0.6;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{flex-shrink:0;display:flex;align-items:center;gap:12px;padding:0 20px;height:54px;border-bottom:1px solid var(--b1);background:rgba(10,10,10,0.97);z-index:200;backdrop-filter:blur(12px);}
.logo{font-family:'Playfair Display',serif;font-size:22px;letter-spacing:0.01em;margin-right:4px;flex-shrink:0;}
.logo em{color:var(--acc);font-style:italic;}
.header-divider{width:1px;height:24px;background:var(--b2);flex-shrink:0;}
.view-tabs{display:flex;gap:2px;background:var(--s2);border-radius:8px;padding:3px;flex-shrink:0;}
.view-tab{padding:5px 14px;border-radius:6px;border:none;background:transparent;color:var(--t3);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.15s;letter-spacing:0.04em;}
.view-tab:hover{color:var(--t2);}
.view-tab.active{background:var(--s3);color:var(--t1);box-shadow:0 1px 4px rgba(0,0,0,0.4);}
.header-spacer{flex:1;}
.hbtn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;border:1px solid var(--b2);background:transparent;color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.18s;white-space:nowrap;letter-spacing:0.02em;}
.hbtn:hover{border-color:var(--b3);color:var(--t1);}
.hbtn.accent{background:var(--acc);border-color:var(--acc);color:#1a1000;font-weight:700;}
.hbtn.accent:hover{opacity:0.88;color:#1a1000;}
.hbtn svg{flex-shrink:0;}
.drive-btn{position:relative;}
.drive-dot{width:7px;height:7px;border-radius:50%;background:var(--t3);flex-shrink:0;transition:background 0.3s;}
.drive-btn.connected .drive-dot{background:var(--green);}
.drive-btn.connected{border-color:rgba(125,184,160,0.3);color:var(--green);}

/* ‚îÄ‚îÄ PROJECT BAR ‚îÄ‚îÄ */
.project-bar{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:6px 20px;border-bottom:1px solid var(--b1);background:var(--s1);overflow-x:auto;scrollbar-width:none;min-height:40px;}
.project-bar::-webkit-scrollbar{display:none;}
.proj-chip{display:flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;border:1px solid var(--b2);background:transparent;color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;white-space:nowrap;transition:all 0.14s;letter-spacing:0.03em;}
.proj-chip:hover{border-color:var(--acc);color:var(--acc);}
.proj-chip.active{background:var(--acc);border-color:var(--acc);color:#1a1000;font-weight:500;}
.proj-chip.new{border-style:dashed;color:var(--t4);}
.proj-chip.new:hover{color:var(--t3);background:transparent;border-color:var(--b2);}
.proj-del{opacity:0.35;font-size:13px;line-height:1;cursor:pointer;}
.proj-del:hover{opacity:1;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.main{display:flex;flex:1;overflow:hidden;}

/* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
.panel{width:228px;flex-shrink:0;border-right:1px solid var(--b1);background:var(--s1);display:flex;flex-direction:column;overflow:hidden;}
.panel-body{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--b2) transparent;}
.psec{padding:14px 14px 12px;border-bottom:1px solid var(--b1);}
.ptitle{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.ptitle-clear{cursor:pointer;font-size:11px;color:var(--t4);opacity:0.6;transition:opacity 0.15s;}
.ptitle-clear:hover{opacity:1;color:var(--acc);}

/* FILTER */
.fitem{display:flex;align-items:center;gap:7px;padding:6px 7px;border-radius:6px;cursor:pointer;transition:background 0.12s;border:none;background:transparent;color:var(--t2);width:100%;text-align:left;font-family:'Syne',sans-serif;font-size:12px;font-weight:400;}
.fitem:hover{background:var(--s2);color:var(--t1);}
.fitem.active{background:var(--s2);color:var(--t1);}
.fcheck{width:13px;height:13px;border-radius:3px;border:1px solid var(--b3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:8px;transition:all 0.12s;}
.fitem.active .fcheck{background:var(--acc);border-color:var(--acc);color:#1a1000;}
.fdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.fcount{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);}

/* KW CLOUD */
.kw-cloud{display:flex;flex-wrap:wrap;gap:4px;min-height:20px;}
.kwtag{padding:3px 7px;background:var(--s2);border:1px solid var(--b2);border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t2);cursor:pointer;transition:all 0.13s;letter-spacing:0.02em;}
.kwtag:hover{border-color:var(--acc);color:var(--acc);}
.kwtag.active{background:var(--acc2);border-color:var(--acc);color:var(--acc);}
.kw-empty{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);}

/* PALETTE */
.pal-toggle{cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);transition:color 0.15s;user-select:none;}
.pal-toggle:hover{color:var(--acc);}
.pal-entry{display:flex;align-items:center;gap:6px;margin-bottom:7px;}
.pal-thumb{width:26px;height:26px;border-radius:4px;object-fit:cover;border:1px solid var(--b2);flex-shrink:0;cursor:pointer;}
.pal-swatches{display:flex;gap:3px;flex-wrap:wrap;}
.pswatch{width:17px;height:17px;border-radius:3px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:transform 0.1s;}
.pswatch:hover{transform:scale(1.3);z-index:2;}

/* PANEL BOTTOM */
.panel-btns{padding:10px 14px;border-top:1px solid var(--b1);display:flex;flex-direction:column;gap:5px;}
.pbtn{padding:7px 12px;border-radius:7px;border:1px solid var(--b2);background:transparent;color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;transition:all 0.15s;width:100%;text-align:center;font-weight:500;}
.pbtn:hover{border-color:var(--acc);color:var(--acc);}
.pbtn.primary{background:var(--acc2);border-color:var(--acc);color:var(--acc);}
.pbtn.primary:hover{background:var(--acc);color:#1a1000;}

/* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
.canvas-wrap{flex:1;position:relative;overflow:hidden;}
.canvas-wrap::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.035) 1px,transparent 1px);background-size:22px 22px;pointer-events:none;z-index:0;}
.canvas-vp{position:absolute;inset:0;overflow:auto;scrollbar-width:thin;scrollbar-color:var(--b2) transparent;}
.canvas{position:relative;width:5000px;height:4000px;}

/* CANVAS TOOLBAR */
.canvas-toolbar{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:100;display:flex;gap:3px;background:rgba(17,17,17,0.92);border:1px solid var(--b2);border-radius:10px;padding:5px;backdrop-filter:blur(12px);box-shadow:0 4px 20px rgba(0,0,0,0.4);}
.tool-btn{width:34px;height:34px;border-radius:7px;border:none;background:transparent;color:var(--t3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.14s;position:relative;}
.tool-btn:hover{background:var(--s3);color:var(--t1);}
.tool-btn.active{background:var(--acc2);color:var(--acc);}
.tool-sep{width:1px;background:var(--b2);margin:4px 2px;}
.tool-tip{position:absolute;bottom:calc(100%+6px);left:50%;transform:translateX(-50%);background:var(--s3);border:1px solid var(--b2);border-radius:5px;padding:3px 7px;font-family:'JetBrains Mono',monospace;font-size:9px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.15s;}
.tool-btn:hover .tool-tip{opacity:1;}

/* GRID VIEW */
.grid-vw{position:absolute;inset:0;overflow-y:auto;padding:16px;display:none;background:var(--bg);}
.grid-vw.active{display:block;}
.grid-mas{columns:5;column-gap:5px;}
@media(max-width:1400px){.grid-mas{columns:4;}}
@media(max-width:1100px){.grid-mas{columns:3;}}

/* ‚îÄ‚îÄ IMG CARDS (canvas) ‚îÄ‚îÄ */
.icard{position:absolute;border-radius:7px;border:1px solid var(--b1);background:var(--s1);box-shadow:0 3px 14px rgba(0,0,0,0.35);overflow:visible;cursor:grab;min-width:100px;}
.icard:hover{border-color:var(--b3);box-shadow:0 6px 24px rgba(0,0,0,0.5);z-index:10!important;}
.icard.dragging{cursor:grabbing;box-shadow:0 14px 44px rgba(0,0,0,0.7);z-index:300!important;opacity:0.93;}
.icard-img{display:block;width:100%;border-radius:6px 6px 0 0;object-fit:cover;pointer-events:none;background:var(--s2);}
/* HOVER OVERLAY for cats/kws */
.icard-hover{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,0.88) 0%,transparent 100%);border-radius:0 0 6px 6px;padding:24px 8px 8px;opacity:0;transition:opacity 0.2s;pointer-events:none;}
.icard:hover .icard-hover{opacity:1;}
.icard-controls{position:absolute;top:6px;right:6px;display:flex;gap:4px;opacity:0;transition:opacity 0.15s;z-index:5;}
.icard:hover .icard-controls{opacity:1;}
.cc{width:28px;height:28px;border-radius:50%;background:rgba(10,10,10,0.88);border:1px solid var(--b3);color:var(--t2);font-size:13px;display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(8px);transition:all 0.14s;}
.cc:hover{background:var(--acc);color:#1a1000;border-color:var(--acc);}
.cc.del:hover{background:var(--red);border-color:var(--red);color:white;}
.rhandle{position:absolute;bottom:0;right:0;width:14px;height:14px;cursor:se-resize;opacity:0;transition:opacity 0.15s;z-index:5;}
.icard:hover .rhandle{opacity:1;}
.rhandle::after{content:'';position:absolute;bottom:3px;right:3px;width:7px;height:7px;border-right:2px solid var(--b3);border-bottom:2px solid var(--b3);border-radius:1px;}
/* hover badges */
.hov-cats{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:3px;}
.hov-kws{display:flex;gap:3px;flex-wrap:wrap;}
.hbadge{padding:2px 5px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:0.04em;text-transform:uppercase;}
.hbadge.comp{background:rgba(107,146,176,0.25);color:var(--comp);}
.hbadge.luz{background:rgba(212,168,90,0.22);color:var(--luz);}
.hbadge.col{background:rgba(125,184,160,0.22);color:var(--col);}
.hkw{padding:1px 5px;background:rgba(255,255,255,0.06);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:8px;color:rgba(255,255,255,0.45);}
/* dim for filter */
.icard.dimmed,.sticky.dimmed{opacity:0.22;filter:saturate(0.1);}

/* ‚îÄ‚îÄ GRID CARDS ‚îÄ‚îÄ */
.gcard{break-inside:avoid;margin-bottom:5px;border-radius:6px;border:1px solid var(--b1);background:var(--s1);overflow:hidden;animation:fadeUp 0.2s ease;cursor:pointer;position:relative;}
.gcard:hover{border-color:var(--b2);}
@keyframes fadeUp{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.gcard img{width:100%;display:block;}
.gcard-hover{padding:6px 7px;background:var(--s2);display:none;}
.gcard:hover .gcard-hover{display:block;}
.gcard-controls{position:absolute;top:5px;right:5px;display:flex;gap:3px;opacity:0;transition:opacity 0.14s;}
.gcard:hover .gcard-controls{opacity:1;}
.grid-note-above{border-radius:4px 4px 0 0;padding:7px 9px;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.5;break-inside:avoid;}
.grid-free-note{break-inside:avoid;margin-bottom:5px;border-radius:5px;padding:8px 10px;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.5;cursor:pointer;}

/* ‚îÄ‚îÄ STICKY NOTES ‚îÄ‚îÄ */
.sticky{position:absolute;border-radius:2px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.55;cursor:grab;user-select:none;box-shadow:2px 4px 14px rgba(0,0,0,0.45);z-index:50;min-width:100px;max-width:185px;overflow:visible;}
.sticky:hover{z-index:80!important;}
.sticky.dragging{cursor:grabbing;box-shadow:4px 10px 28px rgba(0,0,0,0.65);z-index:350!important;opacity:0.93;}
.sticky.anchored{cursor:default;}
.sticky-inner{padding:10px 12px 12px;position:relative;}
.sticky-inner::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:rgba(0,0,0,0.1);border-radius:2px 2px 0 0;}
.sticky-text{padding-right:10px;white-space:pre-wrap;word-break:break-word;}
.sticky-controls{position:absolute;top:5px;right:5px;display:flex;gap:3px;opacity:0;transition:opacity 0.15s;}
.sticky:hover .sticky-controls{opacity:1;}
.sc{width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,0.18);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;color:rgba(0,0,0,0.5);transition:all 0.13s;padding:0;}
.sc:hover{background:rgba(0,0,0,0.32);color:rgba(0,0,0,0.9);}
.sticky-hover-info{padding:5px 10px 7px;border-top:1px solid rgba(0,0,0,0.1);font-size:9px;opacity:0;transition:opacity 0.15s;display:flex;gap:4px;flex-wrap:wrap;}
.sticky:hover .sticky-hover-info{opacity:1;}
.sy{background:#f5e86c;color:#2a2010;}
.sp{background:#f5a8ba;color:#2a1018;}
.sb{background:#a8d0f5;color:#101828;}
.sg{background:#a8f0be;color:#102818;}
.so{background:#f5c870;color:#281e08;}

/* CANVAS ELEMENTS */
.canvas-title{position:absolute;cursor:grab;z-index:40;user-select:none;}
.canvas-title:hover{z-index:60!important;}
.canvas-title.dragging{cursor:grabbing;z-index:400!important;}
.title-text{font-family:'Playfair Display',serif;font-size:28px;color:var(--t1);padding:4px 8px;border:1px solid transparent;border-radius:4px;outline:none;background:transparent;min-width:80px;cursor:inherit;}
.canvas-title:hover .title-text{border-color:var(--b3);}
.canvas-title .title-controls{position:absolute;top:-24px;right:0;display:flex;gap:3px;opacity:0;transition:opacity 0.15s;}
.canvas-title:hover .title-controls{opacity:1;}

.canvas-box{position:absolute;cursor:grab;z-index:30;border-radius:6px;border:1px solid var(--b2);}
.canvas-box:hover{z-index:50!important;}
.canvas-box.dragging{cursor:grabbing;z-index:400!important;}
.box-resize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:se-resize;opacity:0;}
.canvas-box:hover .box-resize{opacity:1;}
.box-resize::after{content:'';position:absolute;bottom:2px;right:2px;width:7px;height:7px;border-right:2px solid rgba(255,255,255,0.2);border-bottom:2px solid rgba(255,255,255,0.2);}
.box-controls{position:absolute;top:-24px;right:0;display:flex;gap:3px;opacity:0;transition:opacity 0.15s;}
.canvas-box:hover .box-controls{opacity:1;}

/* ARROW SVG */
#arrowLayer{position:absolute;inset:0;pointer-events:none;overflow:visible;}
.arrow-el{pointer-events:all;cursor:pointer;}
.arrow-handle{fill:var(--acc);stroke:var(--bg);stroke-width:2;cursor:move;r:7;}

/* EMPTY */
.empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--t4);pointer-events:none;z-index:1;}
.empty-state h3{font-family:'Playfair Display',serif;font-size:22px;color:var(--t3);}
.empty-state p{font-size:12px;max-width:260px;text-align:center;line-height:1.6;color:var(--t4);}

/* STATUS BAR */
.statusbar{flex-shrink:0;height:26px;border-top:1px solid var(--b1);background:var(--s1);display:flex;align-items:center;padding:0 16px;gap:14px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);letter-spacing:0.05em;}
.sb-sep{color:var(--b3);}

/* LOADING */
.loader{position:fixed;inset:0;background:rgba(10,10,10,0.92);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;backdrop-filter:blur(12px);}
.loader h3{font-family:'Playfair Display',serif;font-size:22px;color:var(--t1);}
.loader p{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--t2);}
.spin{width:30px;height:30px;border:2px solid var(--b2);border-top-color:var(--acc);border-radius:50%;animation:spin 0.65s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* MODALS */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(10px);animation:fi 0.15s ease;}
@keyframes fi{from{opacity:0}to{opacity:1}}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:12px;padding:22px;width:100%;max-width:480px;box-shadow:0 30px 70px rgba(0,0,0,0.65);animation:su 0.18s ease;max-height:90vh;overflow-y:auto;}
@keyframes su{from{transform:translateY(10px);opacity:0}to{transform:none;opacity:1}}
.modal h2{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:16px;color:var(--t1);}
.fg{margin-bottom:12px;}
.fg label{display:block;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t2);text-transform:uppercase;letter-spacing:0.09em;margin-bottom:5px;}
.fg input,.fg textarea,.fg select{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:6px;padding:8px 11px;color:var(--t1);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color 0.18s;}
.fg input:focus,.fg textarea:focus{border-color:var(--acc);}
.fg textarea{resize:vertical;min-height:56px;}
.mactions{display:flex;gap:7px;justify-content:flex-end;margin-top:14px;}
.mbtn{padding:7px 14px;border-radius:6px;border:1px solid var(--b2);background:transparent;color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.15s;}
.mbtn:hover{border-color:var(--b3);color:var(--t1);}
.mbtn.ok{background:var(--acc);border-color:var(--acc);color:#1a1000;font-weight:700;}
.mbtn.ok:hover{opacity:0.88;color:#1a1000;}
.mbtn.danger{border-color:var(--red);color:var(--red);}
.mbtn.danger:hover{background:var(--red);color:white;}

/* TABS */
.tab-bar{display:flex;gap:2px;background:var(--s2);border-radius:7px;padding:3px;margin-bottom:13px;}
.tb{flex:1;padding:6px;border-radius:5px;border:none;background:transparent;color:var(--t2);font-size:12px;cursor:pointer;transition:all 0.14s;font-family:'Syne',sans-serif;}
.tb.active{background:var(--s3);color:var(--t1);box-shadow:0 1px 4px rgba(0,0,0,0.3);}

/* DROP ZONE */
.dz{border:2px dashed var(--b2);border-radius:8px;padding:22px;text-align:center;color:var(--t2);font-size:12px;cursor:pointer;transition:all 0.18s;}
.dz:hover,.dz.over{border-color:var(--acc);color:var(--acc);background:var(--acc2);}
.dz input{display:none;}

/* CAT CHECKS */
.cat-checks{display:flex;flex-direction:column;gap:5px;}
.cch{display:flex;align-items:center;gap:8px;cursor:pointer;padding:5px 7px;border-radius:6px;transition:background 0.12s;}
.cch:hover{background:var(--s2);}
.cch input[type=checkbox]{width:13px;height:13px;accent-color:var(--acc);cursor:pointer;flex-shrink:0;}
.cch span{font-size:12px;color:var(--t2);}

/* KW INPUT */
.kw-wrap{position:relative;}
.kw-ac{position:absolute;top:100%;left:0;right:0;background:var(--s2);border:1px solid var(--b2);border-radius:6px;z-index:20;display:none;max-height:110px;overflow-y:auto;}
.kw-ac.vis{display:block;}
.kw-ac-item{padding:6px 10px;cursor:pointer;font-size:12px;color:var(--t2);transition:background 0.1s;}
.kw-ac-item:hover{background:var(--s3);color:var(--t1);}
.kw-pills{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;}
.kw-pill{padding:2px 7px;background:var(--s2);border:1px solid var(--b2);border-radius:9px;font-size:11px;display:flex;align-items:center;gap:3px;color:var(--t2);}
.kw-pill-x{cursor:pointer;opacity:0.4;font-size:12px;}
.kw-pill-x:hover{opacity:1;}

/* NOTE COLORS */
.nc-row{display:flex;gap:6px;}
.nc-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.13s;}
.nc-dot.sel{border-color:white;transform:scale(1.2);}

/* PINTEREST */
.pin-hint{background:rgba(200,70,70,0.07);border:1px solid rgba(200,70,70,0.2);border-radius:6px;padding:7px 10px;font-size:11px;color:#e08080;display:none;margin-top:5px;line-height:1.55;}
.pin-hint.vis{display:block;}

/* COLOR PICKER for box */
.color-row{display:flex;gap:5px;flex-wrap:wrap;}
.col-dot{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.13s;}
.col-dot.sel{border-color:white;transform:scale(1.15);}

/* PDF */
.pdf-opts{display:flex;flex-direction:column;gap:7px;}
.pdf-opt{display:flex;align-items:center;gap:10px;padding:9px 12px;border:1px solid var(--b2);border-radius:7px;cursor:pointer;transition:all 0.14s;}
.pdf-opt:hover,.pdf-opt.sel{border-color:var(--acc);background:var(--acc2);}
.pdf-opt input{accent-color:var(--acc);}
.pdf-opt-body{display:flex;flex-direction:column;gap:2px;}
.pdf-opt-title{font-weight:600;color:var(--t1);font-size:12px;}
.pdf-opt-desc{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px;}
</style>
</head>
<body>

<!-- LOADER -->
<div class="loader" id="loader">
  <div class="spin"></div>
  <h3>fr<em style="color:var(--acc);font-style:italic">a</em>me</h3>
  <p id="loaderMsg">Iniciando...</p>
</div>

<!-- HEADER -->
<header>
  <div class="logo">fr<em>a</em>me</div>
  <div class="header-divider"></div>
  <div class="view-tabs">
    <button class="view-tab active" id="vCanvas" onclick="setView('canvas')">Canvas</button>
    <button class="view-tab" id="vGrid" onclick="setView('grid')">Grid</button>
  </div>
  <div class="header-spacer"></div>
  <button class="hbtn" onclick="openImport()">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    Importar
  </button>
  <button class="hbtn" onclick="openPdfModal()">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Exportar
  </button>
  <div class="header-divider"></div>
  <button class="hbtn drive-btn" id="driveBtn" onclick="driveAuth()">
    <span class="drive-dot"></span>
    <span id="driveTxt">Conectar Drive</span>
  </button>
  <button class="hbtn" onclick="openNoteModal()">üìù Nota</button>
  <button class="hbtn accent" onclick="openAddModal()">+ Imagen</button>
</header>

<!-- PROJECT BAR -->
<div class="project-bar" id="projectBar"></div>

<!-- MAIN -->
<div class="main">
  <!-- PANEL -->
  <div class="panel">
    <div class="panel-body">
      <!-- CATEGORIES -->
      <div class="psec">
        <div class="ptitle">Categor√≠as <span class="ptitle-clear" onclick="clearCats()">limpiar</span></div>
        <div style="display:flex;flex-direction:column;gap:2px">
          <button class="fitem active" data-cat="all" onclick="toggleCat('all')">
            <span class="fcheck">‚úì</span><span class="fdot" style="background:var(--t4)"></span>Todo
            <span class="fcount" id="fc-all">0</span>
          </button>
          <button class="fitem" data-cat="composicion" onclick="toggleCat('composicion')">
            <span class="fcheck"></span><span class="fdot" style="background:var(--comp)"></span>Composici√≥n
            <span class="fcount" id="fc-composicion">0</span>
          </button>
          <button class="fitem" data-cat="iluminacion" onclick="toggleCat('iluminacion')">
            <span class="fcheck"></span><span class="fdot" style="background:var(--luz)"></span>Iluminaci√≥n
            <span class="fcount" id="fc-iluminacion">0</span>
          </button>
          <button class="fitem" data-cat="color" onclick="toggleCat('color')">
            <span class="fcheck"></span><span class="fdot" style="background:var(--col)"></span>Paleta de color
            <span class="fcount" id="fc-color">0</span>
          </button>
        </div>
      </div>
      <!-- KEYWORDS -->
      <div class="psec">
        <div class="ptitle">Keywords <span class="ptitle-clear" onclick="clearKws()">limpiar</span></div>
        <div class="kw-cloud" id="kwCloud"></div>
      </div>
      <!-- PALETTE -->
      <div class="psec">
        <div class="ptitle">Paletas de color <span class="pal-toggle" id="palToggle" onclick="togglePal()">‚ñ∏ ver</span></div>
        <div id="palContent" style="display:none">
          <div id="palEntries"></div>
          <div style="margin-top:5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4)">Clic en swatch ‚Üí filtra im√°genes similares</div>
        </div>
      </div>
    </div>
    <div class="panel-btns">
      <button class="pbtn primary" onclick="openAddModal()">+ Nueva imagen</button>
      <button class="pbtn" onclick="openNoteModal()">+ Nota suelta</button>
    </div>
  </div>

  <!-- CANVAS -->
  <div class="canvas-wrap" id="canvasWrap">
    <!-- CANVAS TOOLBAR -->
    <div class="canvas-toolbar" id="canvasToolbar">
      <button class="tool-btn active" id="tool-select" onclick="setTool('select')" title="Seleccionar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-7 1-3 7z"/></svg>
        <div class="tool-tip">Seleccionar</div>
      </button>
      <div class="tool-sep"></div>
      <button class="tool-btn" id="tool-title" onclick="setTool('title')">
        <span style="font-family:'Playfair Display',serif;font-size:15px;font-weight:600">T</span>
        <div class="tool-tip">T√≠tulo</div>
      </button>
      <button class="tool-btn" id="tool-box" onclick="setTool('box')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
        <div class="tool-tip">Caja de color</div>
      </button>
      <button class="tool-btn" id="tool-arrow" onclick="setTool('arrow')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        <div class="tool-tip">Flecha</div>
      </button>
      <div class="tool-sep"></div>
      <button class="tool-btn" id="tool-draw" onclick="setTool('draw')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        <div class="tool-tip">Dibujo libre</div>
      </button>
      <button class="tool-btn" id="tool-erase" onclick="setTool('erase')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l11-11 7 7-3.5 3.5"/><path d="M6.5 17.5l3-3"/></svg>
        <div class="tool-tip">Borrador</div>
      </button>
    </div>

    <div class="canvas-vp" id="canvasVp">
      <div class="canvas" id="canvas">
        <svg id="arrowLayer" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;overflow:visible;z-index:20;"></svg>
        <canvas id="drawCanvas" style="position:absolute;inset:0;z-index:15;pointer-events:none;"></canvas>
      </div>
    </div>
    <!-- GRID -->
    <div class="grid-vw" id="gridVw">
      <div class="grid-mas" id="gridMas"></div>
    </div>
    <!-- EMPTY -->
    <div class="empty-state" id="emptyState">
      <div style="font-size:42px;opacity:0.12">üéû</div>
      <h3>Canvas vac√≠o</h3>
      <p>A√±ade tu primera imagen o nota para construir el mood de tu proyecto.</p>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <span id="sbProj">‚Äî</span><span class="sb-sep">¬∑</span>
  <span id="sbImgs">0 imgs</span><span class="sb-sep">¬∑</span>
  <span id="sbNotes">0 notas</span>
  <span style="margin-left:auto;color:var(--t4)">frame v4</span>
</div>

<!-- ‚ïê‚ïê‚ïê ADD IMAGE MODAL ‚ïê‚ïê‚ïê -->
<div class="mbg" id="addModal" style="display:none">
  <div class="modal">
    <h2>Nueva referencia visual</h2>
    <div class="tab-bar">
      <button class="tb active" id="tabUrl" onclick="switchAddTab('url')">üîó URL</button>
      <button class="tb" id="tabFile" onclick="switchAddTab('file')">üìÅ Archivo</button>
    </div>
    <div id="urlTab">
      <div class="fg">
        <label>URL de imagen</label>
        <input type="text" id="imgUrl" placeholder="https://..." oninput="checkPin(this.value)">
        <div class="pin-hint" id="pinHint">‚ö†Ô∏è Pinterest bloquea carga directa. Descarga la imagen ‚Üí sube desde archivo.</div>
      </div>
    </div>
    <div id="fileTab" style="display:none">
      <div class="dz" id="dropZone" onclick="document.getElementById('fileIn').click()">
        <div style="font-size:26px;margin-bottom:5px">üñº</div>
        <div>Arrastra o haz clic</div>
        <div style="font-size:10px;color:var(--t4);margin-top:2px">JPG ¬∑ PNG ¬∑ WEBP ¬∑ GIF</div>
        <input type="file" id="fileIn" accept="image/*" onchange="handleFile(event)">
      </div>
      <div id="fileName" style="font-size:11px;color:var(--t2);margin-top:5px;text-align:center"></div>
    </div>
    <div class="fg" style="margin-top:12px">
      <label>Categor√≠as</label>
      <div class="cat-checks">
        <label class="cch"><input type="checkbox" value="composicion" class="imgCat"><span>üìê Composici√≥n</span></label>
        <label class="cch"><input type="checkbox" value="iluminacion" class="imgCat"><span>üí° Iluminaci√≥n</span></label>
        <label class="cch"><input type="checkbox" value="color" class="imgCat"><span>üé® Paleta de color</span></label>
      </div>
    </div>
    <div class="fg">
      <label>Keywords <span style="font-size:9px;color:var(--t4)">(escribe y pulsa coma)</span></label>
      <div class="kw-wrap">
        <input type="text" id="kwIn" placeholder="gran angular, contraluz..." oninput="kwAc('kwIn','kwAcBox',addKws)" onkeydown="kwKey(event,'kwIn','kwAcBox',addKws)">
        <div class="kw-ac" id="kwAcBox"></div>
      </div>
      <div class="kw-pills" id="kwPills"></div>
    </div>
    <div class="fg">
      <label>Nota</label>
      <textarea id="imgNote" placeholder="¬øQu√© te inspira?"></textarea>
    </div>
    <div class="mactions">
      <button class="mbtn" onclick="closeModal('addModal')">Cancelar</button>
      <button class="mbtn ok" onclick="addImage()">A√±adir</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê NOTE MODAL ‚ïê‚ïê‚ïê -->
<div class="mbg" id="noteModal" style="display:none">
  <div class="modal" style="max-width:400px">
    <h2>Nueva nota</h2>
    <div class="fg">
      <label>Texto</label>
      <textarea id="noteTxt" style="min-height:80px" placeholder="Idea, concepto, instrucci√≥n..."></textarea>
    </div>
    <div class="fg">
      <label>Categor√≠as</label>
      <div class="cat-checks">
        <label class="cch"><input type="checkbox" value="composicion" class="noteCat"><span>üìê Composici√≥n</span></label>
        <label class="cch"><input type="checkbox" value="iluminacion" class="noteCat"><span>üí° Iluminaci√≥n</span></label>
        <label class="cch"><input type="checkbox" value="color" class="noteCat"><span>üé® Color</span></label>
      </div>
    </div>
    <div class="fg">
      <label>Keywords <span style="font-size:9px;color:var(--t4)">(coma para a√±adir)</span></label>
      <div class="kw-wrap">
        <input type="text" id="nkwIn" oninput="kwAc('nkwIn','nkwAc',noteKws)" onkeydown="kwKey(event,'nkwIn','nkwAc',noteKws)">
        <div class="kw-ac" id="nkwAc"></div>
      </div>
      <div class="kw-pills" id="nkwPills"></div>
    </div>
    <div class="fg">
      <label>Color</label>
      <div class="nc-row">
        <div class="nc-dot sel" style="background:#f5e86c" data-c="sy" onclick="selNoteColor(this)"></div>
        <div class="nc-dot" style="background:#f5a8ba" data-c="sp" onclick="selNoteColor(this)"></div>
        <div class="nc-dot" style="background:#a8d0f5" data-c="sb" onclick="selNoteColor(this)"></div>
        <div class="nc-dot" style="background:#a8f0be" data-c="sg" onclick="selNoteColor(this)"></div>
        <div class="nc-dot" style="background:#f5c870" data-c="so" onclick="selNoteColor(this)"></div>
      </div>
    </div>
    <div class="mactions">
      <button class="mbtn" onclick="closeModal('noteModal')">Cancelar</button>
      <button class="mbtn ok" onclick="addNote()">A√±adir</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EDIT IMAGE ‚ïê‚ïê‚ïê -->
<div class="mbg" id="editImgModal" style="display:none">
  <div class="modal">
    <h2>Editar imagen</h2>
    <input type="hidden" id="eImgId">
    <div class="fg">
      <label>Categor√≠as</label>
      <div class="cat-checks">
        <label class="cch"><input type="checkbox" value="composicion" class="eCat"><span>üìê Composici√≥n</span></label>
        <label class="cch"><input type="checkbox" value="iluminacion" class="eCat"><span>üí° Iluminaci√≥n</span></label>
        <label class="cch"><input type="checkbox" value="color" class="eCat"><span>üé® Color</span></label>
      </div>
    </div>
    <div class="fg">
      <label>Keywords</label>
      <div class="kw-wrap">
        <input type="text" id="ekwIn" oninput="kwAc('ekwIn','ekwAc',editKws)" onkeydown="kwKey(event,'ekwIn','ekwAc',editKws)">
        <div class="kw-ac" id="ekwAc"></div>
      </div>
      <div class="kw-pills" id="ekwPills"></div>
    </div>
    <div class="fg">
      <label>Nota</label>
      <textarea id="eImgNote"></textarea>
    </div>
    <div class="mactions">
      <button class="mbtn danger" onclick="delImgFromEdit()">Eliminar</button>
      <button class="mbtn" onclick="closeModal('editImgModal')">Cancelar</button>
      <button class="mbtn ok" onclick="saveImgEdit()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EDIT NOTE ‚ïê‚ïê‚ïê -->
<div class="mbg" id="editNoteModal" style="display:none">
  <div class="modal" style="max-width:400px">
    <h2>Editar nota</h2>
    <input type="hidden" id="eNoteId">
    <div class="fg">
      <label>Texto</label>
      <textarea id="eNoteTxt" style="min-height:80px"></textarea>
    </div>
    <div class="fg">
      <label>Categor√≠as</label>
      <div class="cat-checks">
        <label class="cch"><input type="checkbox" value="composicion" class="eNoteCat"><span>üìê Composici√≥n</span></label>
        <label class="cch"><input type="checkbox" value="iluminacion" class="eNoteCat"><span>üí° Iluminaci√≥n</span></label>
        <label class="cch"><input type="checkbox" value="color" class="eNoteCat"><span>üé® Color</span></label>
      </div>
    </div>
    <div class="fg">
      <label>Keywords</label>
      <div class="kw-wrap">
        <input type="text" id="enkwIn" oninput="kwAc('enkwIn','enkwAc',editNoteKws)" onkeydown="kwKey(event,'enkwIn','enkwAc',editNoteKws)">
        <div class="kw-ac" id="enkwAc"></div>
      </div>
      <div class="kw-pills" id="enkwPills"></div>
    </div>
    <div class="fg">
      <label>Color</label>
      <div class="nc-row" id="eNoteColors">
        <div class="nc-dot" style="background:#f5e86c" data-c="sy" onclick="selEditNoteColor(this)"></div>
        <div class="nc-dot" style="background:#f5a8ba" data-c="sp" onclick="selEditNoteColor(this)"></div>
        <div class="nc-dot" style="background:#a8d0f5" data-c="sb" onclick="selEditNoteColor(this)"></div>
        <div class="nc-dot" style="background:#a8f0be" data-c="sg" onclick="selEditNoteColor(this)"></div>
        <div class="nc-dot" style="background:#f5c870" data-c="so" onclick="selEditNoteColor(this)"></div>
      </div>
    </div>
    <div class="mactions">
      <button class="mbtn danger" onclick="delNoteFromEdit()">Eliminar</button>
      <button class="mbtn" onclick="closeModal('editNoteModal')">Cancelar</button>
      <button class="mbtn ok" onclick="saveNoteEdit()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BOX COLOR MODAL ‚ïê‚ïê‚ïê -->
<div class="mbg" id="boxModal" style="display:none">
  <div class="modal" style="max-width:320px">
    <h2>Nueva caja</h2>
    <div class="fg">
      <label>Color de fondo</label>
      <div class="color-row" id="boxColors">
        <div class="col-dot sel" style="background:#1a1a2e" data-col="#1a1a2e" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#2a1a0e" data-col="#2a1a0e" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#0e2a1a" data-col="#0e2a1a" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#2a0e1a" data-col="#2a0e1a" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#1a2a0e" data-col="#1a2a0e" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#2a2a0e" data-col="#2a2a0e" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#1e1e1e" data-col="#1e1e1e" onclick="selBoxColor(this)"></div>
        <div class="col-dot" style="background:#2d2416" data-col="#2d2416" onclick="selBoxColor(this)"></div>
      </div>
    </div>
    <div class="fg">
      <label>Color personalizado</label>
      <input type="color" id="boxCustomColor" value="#1a1a2e" style="width:100%;height:36px;border-radius:6px;border:1px solid var(--b2);background:var(--s2);cursor:pointer;padding:2px;">
    </div>
    <div class="mactions">
      <button class="mbtn" onclick="closeModal('boxModal')">Cancelar</button>
      <button class="mbtn ok" onclick="placeBox()">Crear</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PROJECT MODAL ‚ïê‚ïê‚ïê -->
<div class="mbg" id="projModal" style="display:none">
  <div class="modal" style="max-width:320px">
    <h2>Nuevo proyecto</h2>
    <div class="fg">
      <label>Nombre</label>
      <input type="text" id="projNameIn" placeholder="Cortometraje 2025..." onkeydown="if(event.key==='Enter')createProj()">
    </div>
    <div class="mactions">
      <button class="mbtn" onclick="closeModal('projModal')">Cancelar</button>
      <button class="mbtn ok" onclick="createProj()">Crear</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PDF MODAL ‚ïê‚ïê‚ïê -->
<div class="mbg" id="pdfModal" style="display:none">
  <div class="modal" style="max-width:440px">
    <h2>Exportar PDF</h2>
    <div class="fg">
      <label>Contenido</label>
      <div class="pdf-opts">
        <label class="pdf-opt sel" onclick="this.closest('.pdf-opts').querySelectorAll('.pdf-opt').forEach(x=>x.classList.remove('sel'));this.classList.add('sel')">
          <input type="radio" name="pdfType" value="grid" checked>
          <div class="pdf-opt-body"><div class="pdf-opt-title">üéû Grid visual</div><div class="pdf-opt-desc">Im√°genes con notas y metadata, fondo blanco</div></div>
        </label>
        <label class="pdf-opt" onclick="this.closest('.pdf-opts').querySelectorAll('.pdf-opt').forEach(x=>x.classList.remove('sel'));this.classList.add('sel')">
          <input type="radio" name="pdfType" value="keywords">
          <div class="pdf-opt-body"><div class="pdf-opt-title">üè∑ Keywords y categor√≠as</div><div class="pdf-opt-desc">Resumen textual del proyecto</div></div>
        </label>
      </div>
    </div>
    <div class="fg">
      <label>Formato</label>
      <div style="display:flex;gap:8px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--t2)"><input type="radio" name="pdfSize" value="a4" checked style="accent-color:var(--acc)"> A4</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--t2)"><input type="radio" name="pdfSize" value="a3" style="accent-color:var(--acc)"> A3</label>
      </div>
    </div>
    <div class="fg">
      <label>Orientaci√≥n</label>
      <div style="display:flex;gap:8px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--t2)"><input type="radio" name="pdfOrient" value="landscape" checked style="accent-color:var(--acc)"> Horizontal</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--t2)"><input type="radio" name="pdfOrient" value="portrait" style="accent-color:var(--acc)"> Vertical</label>
      </div>
    </div>
    <div class="mactions">
      <button class="mbtn" onclick="closeModal('pdfModal')">Cancelar</button>
      <button class="mbtn ok" onclick="exportPDF()">Exportar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê IMPORT MODAL ‚ïê‚ïê‚ïê -->
<div class="mbg" id="importModal" style="display:none">
  <div class="modal" style="max-width:380px">
    <h2>Importar datos</h2>
    <div class="fg">
      <label>Pega el JSON exportado anteriormente</label>
      <textarea id="importJson" style="min-height:120px;font-family:'JetBrains Mono',monospace;font-size:11px" placeholder='{"projects":[...],...}'></textarea>
    </div>
    <div class="mactions">
      <button class="mbtn" onclick="closeModal('importModal')">Cancelar</button>
      <button class="mbtn ok" onclick="doImport()">Importar</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLIENT_ID='1084073419079-j6v6s95h5lap3n6brv5c97g7ip2ubedl.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.file';
let tokenClient=null,accessToken=null,rootFolderId=null,dataFileId=null;
let saving=false,saveQ=false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEF_PROJ='Mi proyecto';
let S={
  projects:[DEF_PROJ],
  active:DEF_PROJ,
  images:{},    // proj -> [{id,src,categories,keywords,note,x,y,w}]
  notes:{},     // proj -> [{id,text,color,categories,keywords,x,y,rot,anchored,anchorTo,_off}]
  titles:{},    // proj -> [{id,text,x,y}]
  boxes:{},     // proj -> [{id,color,x,y,w,h}]
  arrows:{},    // proj -> [{id,x1,y1,x2,y2}]
  drawings:{},  // proj -> [{id,points,color,width}]
  filter:{cats:[],kws:[]},
  view:'canvas',
};

const I=(p)=>{ if(!S.images[p||S.active])S.images[p||S.active]=[]; return S.images[p||S.active]; };
const N=(p)=>{ if(!S.notes[p||S.active])S.notes[p||S.active]=[]; return S.notes[p||S.active]; };
const T=(p)=>{ if(!S.titles[p||S.active])S.titles[p||S.active]=[]; return S.titles[p||S.active]; };
const B=(p)=>{ if(!S.boxes[p||S.active])S.boxes[p||S.active]=[]; return S.boxes[p||S.active]; };
const AR=(p)=>{ if(!S.arrows[p||S.active])S.arrows[p||S.active]=[]; return S.arrows[p||S.active]; };
const DR=(p)=>{ if(!S.drawings[p||S.active])S.drawings[p||S.active]=[]; return S.drawings[p||S.active]; };

function allKws(){
  const s=new Set();
  I().forEach(im=>(im.keywords||[]).forEach(k=>s.add(k)));
  N().forEach(n=>(n.keywords||[]).forEach(k=>s.add(k)));
  return [...s].sort();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function save(){
  if(saving){saveQ=true;return;}
  saving=true;
  try{
    const str=JSON.stringify(S);
    if(accessToken&&rootFolderId){
      const blob=new Blob([str],{type:'application/json'});
      if(dataFileId){
        await driveReq(`https://www.googleapis.com/upload/drive/v3/files/${dataFileId}?uploadType=media`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:blob});
      } else {
        const meta={name:'frame_data.json',parents:[rootFolderId]};
        const form=new FormData();
        form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
        form.append('file',blob);
        const r=await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',body:form});
        dataFileId=(await r.json()).id;
      }
    } else {
      // localStorage fallback (metadata only, no image data to avoid quota)
      const lite={projects:S.projects,active:S.active,filter:S.filter,view:S.view,
        notes:S.notes,titles:S.titles,boxes:S.boxes,arrows:S.arrows,drawings:S.drawings};
      try{localStorage.setItem('frame_v4',JSON.stringify(lite));}catch(e){}
    }
  }catch(e){console.error('Save:',e);}
  saving=false;
  if(saveQ){saveQ=false;save();}
}

async function loadFromDrive(){
  setLoader(true,'Cargando desde Drive...');
  try{
    const q=`name='frame_data.json' and '${rootFolderId}' in parents and trashed=false`;
    const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
    const d=await r.json();
    if(d.files&&d.files.length){
      dataFileId=d.files[0].id;
      const fr=await driveReq(`https://www.googleapis.com/drive/v3/files/${dataFileId}?alt=media`);
      const saved=await fr.json();
      ['projects','images','notes','titles','boxes','arrows','drawings'].forEach(k=>{if(saved[k])S[k]=saved[k];});
      if(saved.active&&S.projects.includes(saved.active))S.active=saved.active;
    }
  }catch(e){console.error('Load:',e);}
  setLoader(false);
  renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initDriveAuth(){
  if(typeof google==='undefined')return;
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID,scope:SCOPES,
    callback:async(resp)=>{
      if(resp.error){setDriveUI(false);return;}
      accessToken=resp.access_token;
      setDriveUI(true);
      await initDriveFolder();
      await loadFromDrive();
    }
  });
}
function driveAuth(){
  if(accessToken){save();return;}
  if(tokenClient)tokenClient.requestAccessToken({prompt:'consent'});
}
function setDriveUI(ok){
  const b=document.getElementById('driveBtn');
  const t=document.getElementById('driveTxt');
  b.classList.toggle('connected',ok);
  t.textContent=ok?'Drive conectado':'Conectar Drive';
}
async function driveReq(url,opts={}){
  const r=await fetch(url,{...opts,headers:{Authorization:`Bearer ${accessToken}`,...(opts.headers||{})}});
  if(!r.ok)throw new Error(`Drive ${r.status}`);
  return r;
}
async function initDriveFolder(){
  const q=`name='Frame' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
  const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  const d=await r.json();
  if(d.files&&d.files.length){rootFolderId=d.files[0].id;return;}
  const cr=await driveReq('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:'Frame',mimeType:'application/vnd.google-apps.folder'})});
  rootFolderId=(await cr.json()).id;
}
async function uploadToDrive(b64,fname,proj,cats){
  if(!accessToken||!rootFolderId)return null;
  try{
    const pfId=await getOrCreateFolder(proj,rootFolderId);
    const cat=cats[0]||'general';
    const cfId=await getOrCreateFolder(cat,pfId);
    const bin=atob(b64.split(',')[1]);
    const ab=new ArrayBuffer(bin.length);const ia=new Uint8Array(ab);
    for(let i=0;i<bin.length;i++)ia[i]=bin.charCodeAt(i);
    const mime=b64.split(';')[0].split(':')[1];
    const blob=new Blob([ab],{type:mime});
    const meta={name:fname,parents:[cfId]};
    const form=new FormData();
    form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
    form.append('file',blob);
    const r=await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',body:form});
    const f=await r.json();
    await driveReq(`https://www.googleapis.com/drive/v3/files/${f.id}/permissions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role:'reader',type:'anyone'})});
    return `https://drive.google.com/thumbnail?id=${f.id}&sz=w800`;
  }catch(e){console.error('Upload:',e);return null;}
}
async function getOrCreateFolder(name,parent){
  const q=`name='${name}' and '${parent}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
  const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  const d=await r.json();
  if(d.files&&d.files.length)return d.files[0].id;
  const cr=await driveReq('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,mimeType:'application/vnd.google-apps.folder',parents:[parent]})});
  return(await cr.json()).id;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setView(v){
  S.view=v;
  document.getElementById('vCanvas').classList.toggle('active',v==='canvas');
  document.getElementById('vGrid').classList.toggle('active',v==='grid');
  document.getElementById('canvasVp').style.display=v==='canvas'?'':'none';
  document.getElementById('canvasToolbar').style.display=v==='canvas'?'':'none';
  document.getElementById('gridVw').classList.toggle('active',v==='grid');
  if(v==='grid')renderGrid();
  else renderCanvas();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProjectBar(){
  const bar=document.getElementById('projectBar');
  bar.innerHTML='';
  S.projects.forEach(p=>{
    const c=document.createElement('button');
    c.className='proj-chip'+(p===S.active?' active':'');
    c.innerHTML=`<span>${esc(p)}</span>`;
    if(p!==S.active){
      const d=document.createElement('span');
      d.className='proj-del';d.textContent='√ó';
      d.onclick=e=>{e.stopPropagation();delProj(p);};
      c.appendChild(d);
    }
    c.onclick=e=>{if(e.target.classList.contains('proj-del'))return;switchProj(p);};
    bar.appendChild(c);
  });
  const a=document.createElement('button');
  a.className='proj-chip new';a.textContent='+ Proyecto';
  a.onclick=()=>{document.getElementById('projNameIn').value='';openModal('projModal');};
  bar.appendChild(a);
}
function switchProj(p){
  S.active=p;S.filter={cats:[],kws:[]};
  save();renderAll();
}
function createProj(){
  const n=document.getElementById('projNameIn').value.trim();
  if(!n||S.projects.includes(n))return;
  S.projects.push(n);switchProj(n);closeModal('projModal');
}
function delProj(p){
  if(!confirm(`¬øEliminar proyecto "${p}"?`))return;
  S.projects=S.projects.filter(x=>x!==p);
  ['images','notes','titles','boxes','arrows','drawings'].forEach(k=>delete S[k][p]);
  if(S.active===p)S.active=S.projects[0]||DEF_PROJ;
  save();renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCat(c){
  if(c==='all'){S.filter.cats=[];}
  else{
    const i=S.filter.cats.indexOf(c);
    if(i>=0)S.filter.cats.splice(i,1);
    else S.filter.cats.push(c);
  }
  updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();
}
function clearCats(){S.filter.cats=[];updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();}
function clearKws(){S.filter.kws=[];updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();}
function toggleKw(k){
  const i=S.filter.kws.indexOf(k);
  if(i>=0)S.filter.kws.splice(i,1);else S.filter.kws.push(k);
  updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();
}
function updateFilterUI(){
  document.querySelectorAll('.fitem').forEach(el=>{
    const c=el.dataset.cat;
    const ok=c==='all'?S.filter.cats.length===0:S.filter.cats.includes(c);
    el.classList.toggle('active',ok);
    el.querySelector('.fcheck').textContent=ok?'‚úì':'';
  });
  document.querySelectorAll('.kwtag').forEach(el=>el.classList.toggle('active',S.filter.kws.includes(el.dataset.kw)));
  updateCounts();
}
function matches(item){
  const cats=item.categories||[];
  const catOk=S.filter.cats.length===0||cats.some(c=>S.filter.cats.includes(c));
  const kwOk=S.filter.kws.length===0||S.filter.kws.some(k=>(item.keywords||[]).includes(k));
  return catOk&&kwOk;
}
function hasActiveFilter(){return S.filter.cats.length>0||S.filter.kws.length>0;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KW CLOUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKwCloud(){
  const c=document.getElementById('kwCloud');
  const kws=allKws();
  c.innerHTML=kws.length
    ?kws.map(k=>`<span class="kwtag${S.filter.kws.includes(k)?' active':''}" data-kw="${esc(k)}" onclick="toggleKw('${esc(k)}')">${esc(k)}</span>`).join('')
    :'<span class="kw-empty">Sin keywords a√∫n</span>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD IMAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let addTab='url',fileData=null,addKws=[];
function openAddModal(){
  addKws=[];fileData=null;
  ['imgUrl','imgNote','kwIn'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('kwPills').innerHTML='';
  document.getElementById('fileName').textContent='';
  document.getElementById('pinHint').classList.remove('vis');
  document.querySelectorAll('.imgCat').forEach(c=>c.checked=false);
  switchAddTab('url');openModal('addModal');
}
function switchAddTab(t){
  addTab=t;
  document.getElementById('urlTab').style.display=t==='url'?'':'none';
  document.getElementById('fileTab').style.display=t==='file'?'':'none';
  document.getElementById('tabUrl').classList.toggle('active',t==='url');
  document.getElementById('tabFile').classList.toggle('active',t==='file');
}
function checkPin(v){document.getElementById('pinHint').classList.toggle('vis',v.includes('pinterest')||v.includes('pin.it')||v.includes('pinimg'));}
function handleFile(e){
  const f=e.target.files[0];if(!f)return;
  compress(f,d=>{fileData=d;document.getElementById('fileName').textContent='‚úì '+f.name;});
}
function compress(file,cb){
  const r=new FileReader();
  r.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const ratio=Math.min(1,1400/img.width);
      c.width=img.width*ratio;c.height=img.height*ratio;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      cb(c.toDataURL('image/jpeg',0.82));
    };img.src=ev.target.result;
  };r.readAsDataURL(file);
}
const dz=document.getElementById('dropZone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))compress(f,d=>{fileData=d;document.getElementById('fileName').textContent='‚úì '+f.name;});});

async function addImage(){
  const cats=[...document.querySelectorAll('.imgCat:checked')].map(c=>c.value);
  const note=document.getElementById('imgNote').value.trim();
  let src='';
  if(addTab==='url'){src=document.getElementById('imgUrl').value.trim();if(!src)return alert('Introduce URL');}
  else{
    if(!fileData)return alert('Selecciona imagen');
    if(accessToken&&rootFolderId){
      setLoader(true,'Subiendo a Drive...');
      const url=await uploadToDrive(fileData,'img_'+Date.now()+'.jpg',S.active,cats);
      src=url||fileData;setLoader(false);
    }else src=fileData;
  }
  const n=I().length;const col=n%5;const row=Math.floor(n/5);
  const im={id:Date.now(),src,categories:cats.length?cats:['composicion'],keywords:[...addKws],note,x:40+col*240,y:40+row*290,w:200};
  I().push(im);save();closeModal('addModal');
  renderCanvas();if(S.view==='grid')renderGrid();
  renderKwCloud();updateCounts();renderPalette();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KW INPUT SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function kwKey(e,inId,acId,list){
  if(e.key===','){
    e.preventDefault();
    const v=e.target.value.replace(',','').trim();
    if(v&&!list.includes(v)){list.push(v);renderPills(list,inId.replace('In','Pills'),list);}
    e.target.value='';
    document.getElementById(acId).classList.remove('vis');
  }
}
function kwAc(inId,acId,list){
  const v=document.getElementById(inId).value.trim();
  const ac=document.getElementById(acId);
  if(!v){ac.classList.remove('vis');return;}
  const matches=allKws().filter(k=>k.toLowerCase().includes(v.toLowerCase())&&!list.includes(k));
  if(!matches.length){ac.classList.remove('vis');return;}
  ac.classList.add('vis');
  ac.innerHTML=matches.slice(0,6).map(k=>`<div class="kw-ac-item" onclick="pickKw('${esc(k)}','${inId}','${acId}',${list===addKws?'addKws':list===noteKws?'noteKws':list===editKws?'editKws':'editNoteKws'})">${esc(k)}</div>`).join('');
}
function pickKw(k,inId,acId,list){
  if(!list.includes(k)){list.push(k);renderPills(list,inId.replace('In','Pills'),list);}
  document.getElementById(inId).value='';
  document.getElementById(acId).classList.remove('vis');
}
function renderPills(list,pillsId,ref){
  const c=document.getElementById(pillsId);
  if(!c)return;
  c.innerHTML=list.map((k,i)=>`<div class="kw-pill">${esc(k)}<span class="kw-pill-x" onclick="rmKw(${i},'${pillsId}',${ref===addKws?'addKws':ref===noteKws?'noteKws':ref===editKws?'editKws':'editNoteKws'})">√ó</span></div>`).join('');
}
function rmKw(i,pillsId,list){list.splice(i,1);renderPills(list,pillsId,list);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let noteColor='sy',noteKws=[];
function selNoteColor(el){document.querySelectorAll('.nc-row .nc-dot').forEach(n=>n.classList.remove('sel'));el.classList.add('sel');noteColor=el.dataset.c;}
function openNoteModal(){
  noteKws=[];noteColor='sy';
  document.getElementById('noteTxt').value='';
  document.getElementById('nkwIn').value='';
  document.getElementById('nkwPills').innerHTML='';
  document.querySelectorAll('.noteCat').forEach(c=>c.checked=false);
  document.querySelectorAll('#noteModal .nc-dot').forEach(d=>{d.classList.toggle('sel',d.dataset.c==='sy');});
  openModal('noteModal');
}
function addNote(){
  const text=document.getElementById('noteTxt').value.trim();if(!text)return;
  const cats=[...document.querySelectorAll('.noteCat:checked')].map(c=>c.value);
  const vp=document.getElementById('canvasVp');
  const note={id:Date.now(),text,color:noteColor,categories:cats,keywords:[...noteKws],x:vp.scrollLeft+80+Math.random()*300,y:vp.scrollTop+60+Math.random()*200,rot:Math.random()*8-4,anchored:false,anchorTo:null,_off:null};
  N().push(note);save();closeModal('noteModal');
  renderCanvas();renderKwCloud();updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCanvas(){
  const canvas=document.getElementById('canvas');
  canvas.querySelectorAll('.icard,.sticky,.canvas-title,.canvas-box').forEach(el=>el.remove());

  const filtered=hasActiveFilter();
  const showImgs=I().filter(im=>!filtered||matches(im));
  const showNotesFree=N().filter(n=>!n.anchored&&(!filtered||matches(n)));
  const isEmpty=I().length===0&&N().length===0&&T().length===0&&B().length===0;
  document.getElementById('emptyState').style.display=isEmpty?'flex':'none';

  // Boxes (background layer)
  B().forEach(b=>canvas.appendChild(makeBox(b)));
  // Titles
  T().forEach(t=>canvas.appendChild(makeTitle(t)));
  // Arrows
  renderArrows();
  // Draw canvas
  renderDrawings();

  // Images
  I().forEach(im=>{
    const card=makeImgCard(im);
    if(filtered)card.classList.toggle('dimmed',!matches(im));
    canvas.appendChild(card);
    // Anchored notes
    N().filter(n=>n.anchored&&n.anchorTo===im.id).forEach(n=>{
      const sticky=makeSticky(n);
      if(filtered)sticky.classList.toggle('dimmed',!matches(n));
      canvas.appendChild(sticky);
    });
  });

  // Free notes
  showNotesFree.forEach(n=>{
    const sticky=makeSticky(n);
    if(filtered)sticky.classList.toggle('dimmed',!matches(n));
    canvas.appendChild(sticky);
  });
  // Dimmed free notes not matching
  if(filtered){
    N().filter(n=>!n.anchored&&!matches(n)).forEach(n=>{
      const sticky=makeSticky(n);sticky.classList.add('dimmed');canvas.appendChild(sticky);
    });
  }

  updateSB();updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function catCls(c){return{composicion:'comp',iluminacion:'luz',color:'col'}[c]||'comp';}
function catLbl(c){return{composicion:'Comp',iluminacion:'Luz',color:'Color'}[c]||c;}

function makeImgCard(im){
  const el=document.createElement('div');
  el.className='icard';el.dataset.id=im.id;
  el.style.cssText=`left:${im.x}px;top:${im.y}px;width:${im.w}px;z-index:${(im.id%40)+5}`;
  const catBadges=(im.categories||[]).map(c=>`<span class="hbadge ${catCls(c)}">${catLbl(c)}</span>`).join('');
  const kwBadges=(im.keywords||[]).map(k=>`<span class="hkw">${esc(k)}</span>`).join('');
  const h=Math.round(im.w*0.62);
  el.innerHTML=`
    <img class="icard-img" src="${im.src}" style="height:${h}px" alt=""
      onerror="this.style.background='var(--s2)';this.style.height='50px'">
    <div class="icard-hover">
      <div class="hov-cats">${catBadges}</div>
      <div class="hov-kws">${kwBadges}</div>
      ${im.note?`<div style="font-size:9px;color:rgba(255,255,255,0.45);margin-top:3px;font-family:'JetBrains Mono',monospace">${esc(im.note)}</div>`:''}
    </div>
    <div class="icard-controls">
      <div class="cc" title="Editar" onclick="openEditImg(${im.id})">‚úé</div>
      <div class="cc del" title="Eliminar" onclick="delImg(${im.id})">√ó</div>
    </div>
    <div class="rhandle" data-id="${im.id}"></div>`;
  makeDrag(el,im);
  makeResize(el.querySelector('.rhandle'),el,im);
  el.addEventListener('dblclick',e=>{if(!e.target.classList.contains('cc'))openEditImg(im.id);});
  return el;
}

function makeDrag(el,im){
  let sx,sy,sl,st,drag=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('cc')||e.target.classList.contains('rhandle')||e.button!==0)return;
    drag=true;el.classList.add('dragging');
    const vp=document.getElementById('canvasVp');
    sx=e.clientX+vp.scrollLeft;sy=e.clientY+vp.scrollTop;sl=im.x;st=im.y;
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!drag)return;
    const vp=document.getElementById('canvasVp');
    im.x=Math.max(0,sl+(e.clientX+vp.scrollLeft)-sx);
    im.y=Math.max(0,st+(e.clientY+vp.scrollTop)-sy);
    el.style.left=im.x+'px';el.style.top=im.y+'px';
    N().filter(n=>n.anchored&&n.anchorTo===im.id).forEach(n=>{
      if(n._off){n.x=im.x+n._off.dx;n.y=im.y+n._off.dy;}
      const sel=document.querySelector(`.sticky[data-id="${n.id}"]`);
      if(sel){sel.style.left=n.x+'px';sel.style.top=n.y+'px';}
    });
  });
  document.addEventListener('mouseup',()=>{if(drag){drag=false;el.classList.remove('dragging');save();}});
}
function makeResize(handle,card,im){
  let sx,sw,r=false;
  handle.addEventListener('mousedown',e=>{r=true;sx=e.clientX;sw=im.w;e.stopPropagation();e.preventDefault();});
  document.addEventListener('mousemove',e=>{
    if(!r)return;
    const nw=Math.max(120,sw+(e.clientX-sx));im.w=nw;card.style.width=nw+'px';
    card.querySelector('.icard-img').style.height=Math.round(nw*0.62)+'px';
  });
  document.addEventListener('mouseup',()=>{if(r){r=false;save();}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STICKY NOTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeSticky(n){
  const el=document.createElement('div');
  el.className=`sticky ${n.color}`;el.dataset.id=n.id;
  el.style.cssText=`left:${n.x}px;top:${n.y}px;transform:rotate(${n.rot||0}deg);z-index:${n.anchored?45:55}`;
  const catBadges=(n.categories||[]).map(c=>`<span style="font-size:8px;opacity:0.55;background:rgba(0,0,0,0.1);padding:1px 4px;border-radius:3px">${c.substring(0,3)}</span>`).join('');
  const kwStr=(n.keywords||[]).join(' ¬∑ ');
  const lockIcon=n.anchored?'üîí':'üîì';
  el.innerHTML=`
    <div class="sticky-inner">
      <div class="sticky-controls">
        <button class="sc" onclick="toggleAnchor(${n.id})" title="${n.anchored?'Desanclar':'Anclar'}">${lockIcon}</button>
        <button class="sc" onclick="openEditNote(${n.id})">‚úé</button>
        <button class="sc" onclick="delNote(${n.id})">√ó</button>
      </div>
      <div class="sticky-text">${esc(n.text)}</div>
      <div class="sticky-hover-info">
        ${catBadges}
        ${kwStr?`<span style="font-size:9px;opacity:0.5">${esc(kwStr)}</span>`:''}
      </div>
    </div>`;
  if(!n.anchored)makeStickyDrag(el,n);
  el.addEventListener('dblclick',e=>{if(!e.target.classList.contains('sc'))openEditNote(n.id);});
  return el;
}

function makeStickyDrag(el,n){
  let sx,sy,sl,st,drag=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('sc'))return;
    drag=true;el.classList.add('dragging');
    const vp=document.getElementById('canvasVp');
    sx=e.clientX+vp.scrollLeft;sy=e.clientY+vp.scrollTop;sl=n.x;st=n.y;
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!drag)return;
    const vp=document.getElementById('canvasVp');
    n.x=Math.max(0,sl+(e.clientX+vp.scrollLeft)-sx);
    n.y=Math.max(0,st+(e.clientY+vp.scrollTop)-sy);
    el.style.left=n.x+'px';el.style.top=n.y+'px';
  });
  document.addEventListener('mouseup',()=>{if(drag){drag=false;el.classList.remove('dragging');save();}});
}

function toggleAnchor(noteId){
  const note=N().find(n=>n.id===noteId);if(!note)return;
  if(note.anchored){
    note.anchored=false;note.anchorTo=null;note._off=null;
  }else{
    // Find image that overlaps with note
    const nRect={x:note.x,y:note.y,w:180,h:80};
    let target=null;
    I().forEach(im=>{
      const overlapX=nRect.x<im.x+im.w&&nRect.x+nRect.w>im.x;
      const overlapY=nRect.y<im.y+im.w*0.8&&nRect.y+nRect.h>im.y;
      if(overlapX&&overlapY)target=im;
    });
    if(!target){alert('Mueve la nota sobre una imagen para anclarla.');return;}
    note.anchored=true;note.anchorTo=target.id;
    note._off={dx:note.x-target.x,dy:note.y-target.y};
  }
  save();renderCanvas();if(S.view==='grid')renderGrid();
}

function delNote(id){
  S.notes[S.active]=N().filter(n=>n.id!==id);
  save();document.querySelector(`.sticky[data-id="${id}"]`)?.remove();
  updateCounts();renderKwCloud();
}
function delImg(id){
  if(!confirm('¬øEliminar imagen?'))return;
  S.images[S.active]=I().filter(i=>i.id!==id);
  S.notes[S.active]=N().filter(n=>!(n.anchored&&n.anchorTo===id));
  save();renderCanvas();if(S.view==='grid')renderGrid();
  renderKwCloud();renderPalette();updateCounts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editKws=[];
function openEditImg(id){
  const im=I().find(i=>i.id===id);if(!im)return;
  document.getElementById('eImgId').value=id;
  document.getElementById('eImgNote').value=im.note||'';
  document.querySelectorAll('.eCat').forEach(c=>c.checked=(im.categories||[]).includes(c.value));
  editKws=[...(im.keywords||[])];
  document.getElementById('ekwIn').value='';
  renderPills(editKws,'ekwPills',editKws);
  openModal('editImgModal');
}
function saveImgEdit(){
  const id=+document.getElementById('eImgId').value;
  const im=I().find(i=>i.id===id);if(!im)return;
  im.categories=[...document.querySelectorAll('.eCat:checked')].map(c=>c.value);
  if(!im.categories.length)im.categories=['composicion'];
  im.keywords=[...editKws];im.note=document.getElementById('eImgNote').value.trim();
  save();closeModal('editImgModal');renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();renderPalette();
}
function delImgFromEdit(){const id=+document.getElementById('eImgId').value;closeModal('editImgModal');delImg(id);}

let editNoteKws=[],editNoteColorVal='sy';
function selEditNoteColor(el){document.querySelectorAll('#eNoteColors .nc-dot').forEach(n=>n.classList.remove('sel'));el.classList.add('sel');editNoteColorVal=el.dataset.c;}
function openEditNote(id){
  const n=N().find(n=>n.id===id);if(!n)return;
  document.getElementById('eNoteId').value=id;
  document.getElementById('eNoteTxt').value=n.text;
  document.querySelectorAll('.eNoteCat').forEach(c=>c.checked=(n.categories||[]).includes(c.value));
  editNoteKws=[...(n.keywords||[])];editNoteColorVal=n.color;
  document.getElementById('enkwIn').value='';
  renderPills(editNoteKws,'enkwPills',editNoteKws);
  document.querySelectorAll('#eNoteColors .nc-dot').forEach(d=>d.classList.toggle('sel',d.dataset.c===n.color));
  openModal('editNoteModal');
}
function saveNoteEdit(){
  const id=+document.getElementById('eNoteId').value;
  const n=N().find(n=>n.id===id);if(!n)return;
  n.text=document.getElementById('eNoteTxt').value.trim();
  n.categories=[...document.querySelectorAll('.eNoteCat:checked')].map(c=>c.value);
  n.keywords=[...editNoteKws];n.color=editNoteColorVal;
  save();closeModal('editNoteModal');renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();
}
function delNoteFromEdit(){const id=+document.getElementById('eNoteId').value;closeModal('editNoteModal');delNote(id);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS TOOLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTool='select';
let boxColor='#1a1a2e';
let selBoxColorVal='#1a1a2e';

function setTool(t){
  currentTool=t;
  document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tool-'+t)?.classList.add('active');
  const canvas=document.getElementById('canvas');
  const drawC=document.getElementById('drawCanvas');
  drawC.style.pointerEvents=t==='draw'||t==='erase'?'all':'none';
  canvas.style.cursor=t==='title'||t==='box'||t==='arrow'?'crosshair':'default';
  if(t==='box'){openModal('boxModal');}
  if(t==='title'){placeTitleOnClick();}
  if(t==='arrow'){startArrowDraw();}
  if(t==='draw'){startFreehand(false);}
  if(t==='erase'){startFreehand(true);}
}

// TITLES
function placeTitleOnClick(){
  const vp=document.getElementById('canvasVp');
  const handler=e=>{
    if(e.target.closest('.canvas-toolbar'))return;
    const rect=vp.getBoundingClientRect();
    const x=e.clientX-rect.left+vp.scrollLeft;
    const y=e.clientY-rect.top+vp.scrollTop;
    const t={id:Date.now(),text:'T√≠tulo',x,y};
    T().push(t);save();
    const el=makeTitle(t);document.getElementById('canvas').appendChild(el);
    vp.removeEventListener('click',handler);
    setTool('select');
    setTimeout(()=>{const inp=el.querySelector('.title-text');if(inp){inp.focus();inp.select();}},50);
  };
  vp.addEventListener('click',handler,{once:true});
}

function makeTitle(t){
  const el=document.createElement('div');
  el.className='canvas-title';el.dataset.id=t.id;
  el.style.cssText=`left:${t.x}px;top:${t.y}px;z-index:25`;
  el.innerHTML=`
    <div class="title-controls">
      <div class="cc" style="width:20px;height:20px;font-size:10px" onclick="delTitle(${t.id})">√ó</div>
    </div>
    <div class="title-text" contenteditable="true" spellcheck="false">${esc(t.text)}</div>`;
  const txt=el.querySelector('.title-text');
  txt.addEventListener('blur',()=>{t.text=txt.textContent||'T√≠tulo';save();});
  makeDragGeneric(el,t);
  return el;
}

function delTitle(id){S.titles[S.active]=T().filter(t=>t.id!==id);save();document.querySelector(`.canvas-title[data-id="${id}"]`)?.remove();}

// BOXES
function selBoxColor(el){document.querySelectorAll('#boxColors .col-dot').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');selBoxColorVal=el.dataset.col;}
function placeBox(){
  const color=document.getElementById('boxCustomColor').value||selBoxColorVal;
  closeModal('boxModal');
  const vp=document.getElementById('canvasVp');
  const handler=e=>{
    if(e.target.closest('.canvas-toolbar'))return;
    const rect=vp.getBoundingClientRect();
    const x=e.clientX-rect.left+vp.scrollLeft;
    const y=e.clientY-rect.top+vp.scrollTop;
    const b={id:Date.now(),color,x,y,w:220,h:160};
    B().push(b);save();
    document.getElementById('canvas').appendChild(makeBox(b));
    vp.removeEventListener('click',handler);setTool('select');
  };
  vp.addEventListener('click',handler,{once:true});
}

function makeBox(b){
  const el=document.createElement('div');
  el.className='canvas-box';el.dataset.id=b.id;
  el.style.cssText=`left:${b.x}px;top:${b.y}px;width:${b.w}px;height:${b.h}px;background:${b.color};z-index:2`;
  el.innerHTML=`
    <div class="box-controls">
      <div class="cc" style="width:20px;height:20px;font-size:10px" onclick="delBox(${b.id})">√ó</div>
    </div>
    <div class="box-resize" data-id="${b.id}"></div>`;
  const rh=el.querySelector('.box-resize');
  let sx,sy,sw,sh,r=false;
  rh.addEventListener('mousedown',e=>{r=true;sx=e.clientX;sy=e.clientY;sw=b.w;sh=b.h;e.stopPropagation();e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!r)return;b.w=Math.max(80,sw+(e.clientX-sx));b.h=Math.max(60,sh+(e.clientY-sy));el.style.width=b.w+'px';el.style.height=b.h+'px';});
  document.addEventListener('mouseup',()=>{if(r){r=false;save();}});
  makeDragGeneric(el,b);
  return el;
}
function delBox(id){S.boxes[S.active]=B().filter(b=>b.id!==id);save();document.querySelector(`.canvas-box[data-id="${id}"]`)?.remove();}

// Generic drag
function makeDragGeneric(el,obj){
  let sx,sy,sl,st,drag=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('cc')||e.target.classList.contains('box-resize')||e.target.classList.contains('title-text')||e.button!==0)return;
    drag=true;el.classList.add('dragging');
    const vp=document.getElementById('canvasVp');
    sx=e.clientX+vp.scrollLeft;sy=e.clientY+vp.scrollTop;sl=obj.x;st=obj.y;
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!drag)return;
    const vp=document.getElementById('canvasVp');
    obj.x=Math.max(0,sl+(e.clientX+vp.scrollLeft)-sx);
    obj.y=Math.max(0,st+(e.clientY+vp.scrollTop)-sy);
    el.style.left=obj.x+'px';el.style.top=obj.y+'px';
  });
  document.addEventListener('mouseup',()=>{if(drag){drag=false;el.classList.remove('dragging');save();}});
}

// ARROWS
let arrowDrawing=false,arrowStart=null,tempArrow=null;
function startArrowDraw(){
  const vp=document.getElementById('canvasVp');
  const down=e=>{
    const rect=vp.getBoundingClientRect();
    arrowStart={x:e.clientX-rect.left+vp.scrollLeft,y:e.clientY-rect.top+vp.scrollTop};
    arrowDrawing=true;
  };
  const move=e=>{
    if(!arrowDrawing)return;
    const rect=vp.getBoundingClientRect();
    const ex=e.clientX-rect.left+vp.scrollLeft;
    const ey=e.clientY-rect.top+vp.scrollTop;
    drawTempArrow(arrowStart.x,arrowStart.y,ex,ey);
  };
  const up=e=>{
    if(!arrowDrawing)return;
    arrowDrawing=false;
    const rect=vp.getBoundingClientRect();
    const ex=e.clientX-rect.left+vp.scrollLeft;
    const ey=e.clientY-rect.top+vp.scrollTop;
    if(Math.abs(ex-arrowStart.x)>10||Math.abs(ey-arrowStart.y)>10){
      const arr={id:Date.now(),x1:arrowStart.x,y1:arrowStart.y,x2:ex,y2:ey};
      AR().push(arr);save();renderArrows();
    }
    removeTempArrow();
    vp.removeEventListener('mousedown',down);
    vp.removeEventListener('mousemove',move);
    vp.removeEventListener('mouseup',up);
    setTool('select');
  };
  vp.addEventListener('mousedown',down);
  vp.addEventListener('mousemove',move);
  vp.addEventListener('mouseup',up);
}

function drawTempArrow(x1,y1,x2,y2){
  removeTempArrow();
  const svg=document.getElementById('arrowLayer');
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  g.id='tempArrow';
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1',x1);line.setAttribute('y1',y1);line.setAttribute('x2',x2);line.setAttribute('y2',y2);
  line.setAttribute('stroke','rgba(212,168,90,0.7)');line.setAttribute('stroke-width','2');line.setAttribute('stroke-dasharray','6 3');
  g.appendChild(line);svg.appendChild(g);
}
function removeTempArrow(){document.getElementById('tempArrow')?.remove();}

function renderArrows(){
  const svg=document.getElementById('arrowLayer');
  svg.querySelectorAll('.arrow-el').forEach(el=>el.remove());
  svg.innerHTML='<defs><marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="'+getComputedStyle(document.documentElement).getPropertyValue('--acc').trim()+'"/></marker></defs>';
  AR().forEach(arr=>{
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.className.baseVal='arrow-el';g.dataset.id=arr.id;
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',arr.x1);line.setAttribute('y1',arr.y1);line.setAttribute('x2',arr.x2);line.setAttribute('y2',arr.y2);
    line.setAttribute('stroke','var(--acc)');line.setAttribute('stroke-width','2');line.setAttribute('marker-end','url(#ah)');
    const del=document.createElementNS('http://www.w3.org/2000/svg','circle');
    const mx=(arr.x1+arr.x2)/2,my=(arr.y1+arr.y2)/2;
    del.setAttribute('cx',mx);del.setAttribute('cy',my);del.setAttribute('r','6');
    del.setAttribute('fill','var(--red)');del.style.cursor='pointer';del.style.opacity='0';
    del.addEventListener('click',()=>{S.arrows[S.active]=AR().filter(a=>a.id!==arr.id);save();renderArrows();});
    g.addEventListener('mouseenter',()=>del.style.opacity='1');
    g.addEventListener('mouseleave',()=>del.style.opacity='0');
    // Draggable handles
    [['h1',arr,'x1','y1'],['h2',arr,'x2','y2']].forEach(([cls,a,xk,yk])=>{
      const h=document.createElementNS('http://www.w3.org/2000/svg','circle');
      h.setAttribute('cx',a[xk]);h.setAttribute('cy',a[yk]);h.setAttribute('r','7');
      h.setAttribute('fill','var(--acc)');h.setAttribute('stroke','var(--bg)');h.setAttribute('stroke-width','2');
      h.style.cursor='move';h.style.opacity='0';
      g.addEventListener('mouseenter',()=>h.style.opacity='1');
      g.addEventListener('mouseleave',()=>h.style.opacity='0');
      let drag2=false,sx2,sy2;
      h.addEventListener('mousedown',e=>{drag2=true;sx2=e.clientX;sy2=e.clientY;e.stopPropagation();e.preventDefault();});
      document.addEventListener('mousemove',e=>{
        if(!drag2)return;
        const vp=document.getElementById('canvasVp');
        const rect=vp.getBoundingClientRect();
        a[xk]=e.clientX-rect.left+vp.scrollLeft;
        a[yk]=e.clientY-rect.top+vp.scrollTop;
        line.setAttribute('x1',arr.x1);line.setAttribute('y1',arr.y1);line.setAttribute('x2',arr.x2);line.setAttribute('y2',arr.y2);
        h.setAttribute('cx',a[xk]);h.setAttribute('cy',a[yk]);
      });
      document.addEventListener('mouseup',()=>{if(drag2){drag2=false;save();}});
      g.appendChild(h);
    });
    g.appendChild(line);g.appendChild(del);
    svg.appendChild(g);
  });
}

// FREEHAND DRAW
let drawCtx=null,isDrawing=false,currentPath=null,eraseMode=false;
function initDrawCanvas(){
  const dc=document.getElementById('drawCanvas');
  dc.width=5000;dc.height=4000;
  drawCtx=dc.getContext('2d');
  redrawAll();
}

function startFreehand(erase){
  eraseMode=erase;
  const dc=document.getElementById('drawCanvas');
  const vp=document.getElementById('canvasVp');
  dc.style.pointerEvents='all';
  dc.onmousedown=e=>{
    isDrawing=true;
    const rect=dc.getBoundingClientRect();
    const x=e.clientX-rect.left+vp.scrollLeft;
    const y=e.clientY-rect.top+vp.scrollTop;
    currentPath={id:Date.now(),points:[{x,y}],color:erase?null:'#c8a96e',width:erase?20:2.5,erase};
    if(!erase)DR().push(currentPath);
  };
  dc.onmousemove=e=>{
    if(!isDrawing)return;
    const rect=dc.getBoundingClientRect();
    const x=e.clientX-rect.left+vp.scrollLeft;
    const y=e.clientY-rect.top+vp.scrollTop;
    if(currentPath)currentPath.points.push({x,y});
    redrawAll();
  };
  dc.onmouseup=()=>{
    if(!isDrawing)return;
    isDrawing=false;
    if(eraseMode&&currentPath){
      // Erase paths that intersect with eraser path
      const eraserPts=currentPath.points;
      S.drawings[S.active]=DR().filter(d=>{
        if(d.erase)return false;
        return!d.points.some(p=>eraserPts.some(ep=>Math.hypot(p.x-ep.x,p.y-ep.y)<15));
      });
    }
    currentPath=null;save();redrawAll();
    setTool('select');
  };
}

function redrawAll(){
  if(!drawCtx)return;
  drawCtx.clearRect(0,0,5000,4000);
  DR().filter(d=>!d.erase).forEach(d=>{
    if(!d.points||d.points.length<2)return;
    drawCtx.beginPath();
    drawCtx.moveTo(d.points[0].x,d.points[0].y);
    d.points.forEach(p=>drawCtx.lineTo(p.x,p.y));
    drawCtx.strokeStyle=d.color||'#c8a96e';
    drawCtx.lineWidth=d.width||2.5;
    drawCtx.lineCap='round';drawCtx.lineJoin='round';
    drawCtx.stroke();
  });
}
function renderDrawings(){redrawAll();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGrid(){
  const con=document.getElementById('gridMas');
  con.innerHTML='';
  const filtImgs=I().filter(matches);
  const freeNotes=N().filter(n=>!n.anchored&&matches(n));

  // Free notes first
  freeNotes.forEach(n=>{
    const el=document.createElement('div');
    el.className=`grid-free-note ${n.color}`;
    el.innerHTML=`<div>${esc(n.text)}</div>${(n.keywords||[]).length?`<div style="margin-top:3px;font-size:9px;opacity:0.5">${n.keywords.map(k=>esc(k)).join(' ¬∑ ')}</div>`:''}`;
    el.ondblclick=()=>openEditNote(n.id);
    con.appendChild(el);
  });

  filtImgs.forEach(im=>{
    const anchNotes=N().filter(n=>n.anchored&&n.anchorTo===im.id&&matches(n));
    const frag=document.createElement('div');
    frag.style.cssText='break-inside:avoid;margin-bottom:5px;';

    // Anchored notes above
    anchNotes.forEach(n=>{
      const ne=document.createElement('div');
      ne.className=`grid-note-above ${n.color}`;
      ne.innerHTML=`<div style="font-size:10px;line-height:1.5">${esc(n.text)}</div>`;
      frag.appendChild(ne);
    });

    const catBadges=(im.categories||[]).map(c=>`<span class="hbadge ${catCls(c)}">${catLbl(c)}</span>`).join('');
    const kwBadges=(im.keywords||[]).map(k=>`<span class="hkw">${esc(k)}</span>`).join('');

    const card=document.createElement('div');
    card.className='gcard';
    card.innerHTML=`
      <img src="${im.src}" alt="" loading="lazy" style="width:100%;display:block" onerror="this.style.height='40px'">
      <div class="gcard-hover">
        <div class="hov-cats">${catBadges}</div>
        <div class="hov-kws" style="margin-top:3px">${kwBadges}</div>
        ${im.note?`<div style="font-size:9px;color:var(--t3);margin-top:4px;font-family:'JetBrains Mono',monospace">${esc(im.note)}</div>`:''}
      </div>
      <div class="gcard-controls">
        <div class="cc" onclick="openEditImg(${im.id})">‚úé</div>
        <div class="cc del" onclick="delImg(${im.id})">√ó</div>
      </div>`;
    card.ondblclick=()=>openEditImg(im.id);
    frag.appendChild(card);
    con.appendChild(frag);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PALETTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePal(){
  const c=document.getElementById('palContent');
  const t=document.getElementById('palToggle');
  const open=c.style.display==='none';
  c.style.display=open?'':'none';
  t.textContent=open?'‚ñæ ocultar':'‚ñ∏ ver';
  if(open)renderPalette();
}
function renderPalette(){
  const ent=document.getElementById('palEntries');
  const colorImgs=I().filter(im=>(im.categories||[]).includes('color'));
  if(!colorImgs.length){ent.innerHTML='<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">A√±ade imgs en categor√≠a Color</span>';return;}
  ent.innerHTML=colorImgs.map(im=>`<div class="pal-entry"><img src="${im.src}" class="pal-thumb" id="pt${im.id}" crossorigin="anonymous"><div class="pal-swatches" id="ps${im.id}"></div></div>`).join('');
  colorImgs.forEach(im=>{
    const img=document.getElementById(`pt${im.id}`);if(!img)return;
    const extract=()=>{
      try{
        const c=document.createElement('canvas');c.width=40;c.height=40;
        const ctx=c.getContext('2d');ctx.drawImage(img,0,0,40,40);
        const px=ctx.getImageData(0,0,40,40).data;
        const colors=sampleColors(px,5);
        const strip=document.getElementById(`ps${im.id}`);
        if(strip)strip.innerHTML=colors.map(([r,g,b])=>`<div class="pswatch" style="background:rgb(${r},${g},${b})" title="rgb(${r},${g},${b})" onclick="navigator.clipboard.writeText('rgb(${r},${g},${b})')"></div>`).join('');
      }catch(e){}
    };
    img.onload=extract;if(img.complete)extract();
  });
}
function sampleColors(px,n){
  const b={};
  for(let i=0;i<px.length;i+=12){
    const r=Math.round(px[i]/40)*40,g=Math.round(px[i+1]/40)*40,bl=Math.round(px[i+2]/40)*40;
    const k=`${r},${g},${bl}`;b[k]=(b[k]||0)+1;
  }
  return Object.entries(b).sort((a,c)=>c[1]-a[1]).slice(0,n).map(([k])=>k.split(',').map(Number));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPdfModal(){openModal('pdfModal');}
async function exportPDF(){
  const type=document.querySelector('input[name=pdfType]:checked').value;
  const size=document.querySelector('input[name=pdfSize]:checked').value;
  const orient=document.querySelector('input[name=pdfOrient]:checked').value;
  closeModal('pdfModal');
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:orient,unit:'mm',format:size});
  const W=orient==='landscape'?(size==='a3'?420:297):(size==='a3'?297:210);
  const H=orient==='landscape'?(size==='a3'?297:210):(size==='a3'?420:297);

  if(type==='keywords'){
    doc.setFont('helvetica','bold');doc.setFontSize(20);doc.setTextColor(20,20,20);
    doc.text('Frame ‚Äî '+S.active,15,22);
    doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(120);
    doc.text(new Date().toLocaleDateString('es-ES'),15,29);
    let y=40;
    const catDefs=[{id:'composicion',lbl:'Composici√≥n'},{id:'iluminacion',lbl:'Iluminaci√≥n'},{id:'color',lbl:'Paleta de color'}];
    catDefs.forEach(({id,lbl})=>{
      const catImgs=I().filter(im=>(im.categories||[]).includes(id));
      if(!catImgs.length)return;
      doc.setFillColor(240,236,228);doc.roundedRect(12,y-5,W-24,8,1,1,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(11);doc.setTextColor(40,30,10);
      doc.text(lbl,15,y);y+=8;
      doc.setFont('helvetica','normal');doc.setFontSize(9);doc.setTextColor(60);
      const kws=[...new Set(catImgs.flatMap(i=>i.keywords||[]))];
      const kwTxt=kws.length?kws.join(' ¬∑ '):'(sin keywords)';
      const lines=doc.splitTextToSize(kwTxt,W-30);doc.text(lines,15,y);y+=lines.length*4+3;
      catImgs.forEach(im=>{if(im.note){const nl=doc.splitTextToSize('‚Äî '+im.note,W-30);doc.setFontSize(8);doc.setTextColor(90);doc.text(nl,18,y);y+=nl.length*4+2;}});
      y+=5;if(y>H-20){doc.addPage();y=20;}
    });
    doc.addPage();
    doc.setFont('helvetica','bold');doc.setFontSize(14);doc.setTextColor(20);doc.text('Nube de keywords',15,20);
    const allkw=allKws();doc.setFont('helvetica','normal');doc.setFontSize(10);doc.setTextColor(50);
    const kwCloud=allkw.join('   ¬∑   ');const kwLines=doc.splitTextToSize(kwCloud,W-30);doc.text(kwLines,15,30);

  } else {
    // GRID visual PDF
    doc.setFillColor(255,255,255);doc.rect(0,0,W,H,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(18);doc.setTextColor(20,20,20);
    doc.text('Frame ‚Äî '+S.active,15,18);
    doc.setFont('helvetica','normal');doc.setFontSize(8);doc.setTextColor(140);
    doc.text(new Date().toLocaleDateString('es-ES')+' ¬∑ '+I().length+' referencias',15,25);
    let y=33;let col=0;
    const cols=size==='a3'?4:3;
    const imgW=(W-30-(cols-1)*5)/cols;
    const imgH=imgW*0.65;
    const colStep=imgW+5;

    for(const im of I().filter(matches)){
      const x=15+col*colStep;
      doc.setFillColor(245,243,239);doc.roundedRect(x,y,imgW,imgH,1,1,'F');
      if(im.src.startsWith('data:')){
        try{
          doc.addImage(im.src,'JPEG',x,y,imgW,imgH,undefined,'FAST');
        }catch(e){}
      } else {
        doc.setFontSize(7);doc.setTextColor(160);
        doc.text('imagen externa',x+imgW/2,y+imgH/2,{align:'center'});
      }
      // Cat badges
      let bx=x;
      (im.categories||[]).forEach(c=>{
        const lbl={composicion:'COMP',iluminacion:'LUZ',color:'COLOR'}[c]||c.toUpperCase();
        doc.setFillColor(212,168,90);doc.setTextColor(30,20,0);doc.setFontSize(5);
        const bw=doc.getTextWidth(lbl)+4;
        doc.roundedRect(bx,y+imgH+1,bw,3.5,0.5,0.5,'F');
        doc.text(lbl,bx+2,y+imgH+3.3);bx+=bw+2;
      });
      // Keywords
      if((im.keywords||[]).length){
        doc.setTextColor(80);doc.setFontSize(6.5);
        doc.text(im.keywords.join(', '),x,y+imgH+7,{maxWidth:imgW});
      }
      // Note
      if(im.note){
        doc.setTextColor(100);doc.setFontSize(6.5);
        const nl=doc.splitTextToSize(im.note,imgW);doc.text(nl.slice(0,2),x,y+imgH+12);
      }
      // Anchored notes
      const anch=N().filter(n=>n.anchored&&n.anchorTo===im.id);
      if(anch.length){
        doc.setFillColor(245,232,108);doc.setTextColor(40,30,5);doc.setFontSize(6);
        anch.forEach((n,ni)=>{
          const nt=doc.splitTextToSize(n.text,imgW);
          doc.roundedRect(x,y+imgH+17+ni*10,imgW,8,1,1,'F');
          doc.text(nt.slice(0,1),x+2,y+imgH+21+ni*10);
        });
      }
      col++;
      if(col>=cols){col=0;y+=imgH+32;}
      if(y>H-imgH-35){doc.addPage();doc.setFillColor(255,255,255);doc.rect(0,0,W,H,'F');y=15;col=0;}
    }
  }
  doc.save(`frame_${S.active.replace(/\s+/g,'_')}_${type}_${size}.pdf`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORT / EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openImport(){
  document.getElementById('importJson').value='';
  openModal('importModal');
}
function doImport(){
  try{
    const parsed=JSON.parse(document.getElementById('importJson').value);
    if(parsed.projects)S.projects=parsed.projects;
    if(parsed.images)S.images=parsed.images;
    if(parsed.notes)S.notes=parsed.notes;
    if(parsed.titles)S.titles=parsed.titles;
    if(parsed.boxes)S.boxes=parsed.boxes;
    if(parsed.arrows)S.arrows=parsed.arrows;
    if(parsed.drawings)S.drawings=parsed.drawings;
    if(parsed.active)S.active=parsed.active;
    save();closeModal('importModal');renderAll();
  }catch(e){alert('JSON inv√°lido');}
}
// Export button also exports JSON
function openImport2(){
  const json=JSON.stringify(S,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`frame_backup_${Date.now()}.json`;a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTS & STATUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCounts(){
  document.getElementById('fc-all').textContent=I().length;
  ['composicion','iluminacion','color'].forEach(c=>{
    const el=document.getElementById('fc-'+c);
    if(el)el.textContent=I().filter(im=>(im.categories||[]).includes(c)).length;
  });
}
function updateSB(){
  document.getElementById('sbProj').textContent='üìÅ '+S.active;
  document.getElementById('sbImgs').textContent=I().length+' imgs';
  document.getElementById('sbNotes').textContent=N().length+' notas';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){document.getElementById(id).style.display='flex';}
function closeModal(id){document.getElementById(id).style.display='none';}
document.querySelectorAll('.mbg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.style.display='none';}));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')document.querySelectorAll('.mbg').forEach(b=>b.style.display='none');
  if((e.metaKey||e.ctrlKey)&&e.key==='i'){e.preventDefault();openAddModal();}
  if((e.metaKey||e.ctrlKey)&&e.key==='n'){e.preventDefault();openNoteModal();}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLoader(show,msg){
  document.getElementById('loader').style.display=show?'flex':'none';
  if(msg)document.getElementById('loaderMsg').textContent=msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  renderProjectBar();
  if(S.view==='canvas'){renderCanvas();}
  else{renderGrid();}
  renderKwCloud();updateCounts();updateFilterUI();updateSB();renderPalette();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload=()=>{
  // Load GIS
  const script=document.createElement('script');
  script.src='https://accounts.google.com/gsi/client';
  script.onload=()=>{initDriveAuth();setLoader(false);renderAll();initDrawCanvas();};
  script.onerror=()=>{setLoader(false);renderAll();initDrawCanvas();};
  document.head.appendChild(script);

  // Restore from localStorage (fallback, metadata only)
  try{
    const m=localStorage.getItem('frame_v4');
    if(m){const p=JSON.parse(m);['projects','notes','titles','boxes','arrows','drawings'].forEach(k=>{if(p[k])S[k]=p[k];});if(p.active)S.active=p.active;}
  }catch(e){}
};
</script>
</body>
</html>
