<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frame v6</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@300;400;500&family=Syne:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ */
[data-theme="dark"]{
  --bg:#2f2f2f;--s0:#363636;--s1:#3d3d3d;--s2:#444;--s3:#4a4a4a;--s4:#525252;
  --b1:#4a4a4a;--b2:#585858;--b3:#666;
  --t1:#ececec;--t2:#a0a0a0;--t3:#6a6a6a;--t4:#484848;
  --acc:#d4a85a;--acc2:rgba(212,168,90,0.13);--acc3:rgba(212,168,90,0.25);
  --comp:#6b92b0;--luz:#d4a85a;--col:#7db8a0;--red:#c07070;--green:#5dba8a;
  --shadow:rgba(0,0,0,0.4);--cborder:rgba(255,255,255,0.07);
  --glass:rgba(54,54,54,0.92);--hbg:rgba(255,255,255,0.05);
}
[data-theme="light"]{
  --bg:#e8e8e8;--s0:#f0f0f0;--s1:#f8f8f8;--s2:#efefef;--s3:#e5e5e5;--s4:#dcdcdc;
  --b1:#d8d8d8;--b2:#c8c8c8;--b3:#b0b0b0;
  --t1:#1a1a1a;--t2:#6a6a6a;--t3:#9a9a9a;--t4:#c0c0c0;
  --acc:#b8862a;--acc2:rgba(184,134,42,0.1);--acc3:rgba(184,134,42,0.22);
  --comp:#4a72b0;--luz:#b8862a;--col:#5a9880;--red:#903030;--green:#3a9a6a;
  --shadow:rgba(0,0,0,0.1);--cborder:rgba(0,0,0,0.08);
  --glass:rgba(240,240,240,0.94);--hbg:rgba(0,0,0,0.03);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--t1);font-family:'Syne',sans-serif;font-size:13px;display:flex;flex-direction:column;transition:background 0.25s,color 0.25s;}
[data-theme="dark"] body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.02'/%3E%3C/svg%3E");pointer-events:none;z-index:9998;opacity:0.4;}

/* HEADER */
header{flex-shrink:0;display:flex;align-items:center;gap:8px;padding:0 16px;height:50px;border-bottom:1px solid var(--b1);background:var(--s0);z-index:200;}
.logo{font-family:'Playfair Display',serif;font-size:19px;flex-shrink:0;display:flex;align-items:baseline;gap:2px;}
.logo em{color:var(--acc);font-style:italic;}
.logo-ver{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);margin-left:4px;align-self:flex-end;padding-bottom:2px;}
.hdiv{width:1px;height:18px;background:var(--b2);flex-shrink:0;}
.vtabs{display:flex;gap:1px;background:var(--s2);border-radius:7px;padding:3px;border:1px solid var(--b1);}
.vtab{padding:4px 13px;border-radius:5px;border:none;background:transparent;color:var(--t3);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.13s;}
.vtab:hover{color:var(--t2);}
.vtab.active{background:var(--s1);color:var(--t1);box-shadow:0 1px 3px var(--shadow);}
.hsp{flex:1;}
.hpill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:18px;border:1px solid var(--b2);background:var(--s1);color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.13s;white-space:nowrap;}
.hpill:hover{border-color:var(--b3);color:var(--t1);}
.hpill.acc{background:var(--acc);border-color:var(--acc);color:#1a1000;font-weight:700;}
.hpill.acc:hover{opacity:0.88;}
/* Drive button */
.drive-pill{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:18px;border:1px solid var(--b2);background:var(--s1);color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;position:relative;}
.drive-pill:hover{border-color:var(--b3);color:var(--t1);}
.drive-pill.ok{border-color:rgba(93,186,138,0.5);color:var(--green);}
.ddot{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:background 0.3s;flex-shrink:0;}
.drive-pill.ok .ddot{background:var(--green);box-shadow:0 0 6px var(--green);}
/* Save indicator */
.save-ind{position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:var(--s1);border:1px solid var(--b2);border-radius:20px;padding:6px 14px;display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--t2);box-shadow:0 4px 16px var(--shadow);z-index:500;transition:opacity 0.4s;opacity:0;pointer-events:none;}
.save-ind.vis{opacity:1;}
.save-dot{width:8px;height:8px;border-radius:50%;background:var(--acc);animation:pulse 1s infinite;}
.save-tick{font-size:16px;color:var(--green);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
/* Theme toggle - half circle */
.thm-btn{width:30px;height:30px;border-radius:50%;border:1px solid var(--b2);background:transparent;cursor:pointer;overflow:hidden;position:relative;transition:border-color 0.13s;}
.thm-btn:hover{border-color:var(--b3);}
.thm-half-w{position:absolute;top:0;right:0;width:50%;height:100%;background:#f0f0f0;border-radius:0 15px 15px 0;}
.thm-half-b{position:absolute;top:0;left:0;width:50%;height:100%;background:#1a1a1a;border-radius:15px 0 0 15px;}

/* PROJECT BAR */
.pbar{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:4px 16px;border-bottom:1px solid var(--b1);background:var(--s0);overflow-x:auto;scrollbar-width:none;min-height:36px;}
.pbar::-webkit-scrollbar{display:none;}
.pchip{display:flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;border:1px solid var(--b2);background:transparent;color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;white-space:nowrap;transition:all 0.13s;}
.pchip:hover{border-color:var(--acc);color:var(--acc);}
.pchip.active{background:var(--acc);border-color:var(--acc);color:#1a1000;font-weight:600;}
.pchip.newp{border-style:dashed;color:var(--t4);}
.pdel{opacity:0.3;font-size:12px;cursor:pointer;margin-left:1px;}
.pdel:hover{opacity:1;}

/* LAYOUT */
.main{display:flex;flex:1;overflow:hidden;}

/* LEFT PANEL */
.panel{width:214px;flex-shrink:0;border-right:1px solid var(--b1);background:var(--s0);display:flex;flex-direction:column;overflow:hidden;}
.pbody{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--b2) transparent;}
.psec{padding:11px 12px 9px;border-bottom:1px solid var(--b1);}
.ptitle{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:0.11em;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;}
.pclr{cursor:pointer;font-size:10px;color:var(--t4);transition:color 0.13s;}
.pclr:hover{color:var(--acc);}
/* Filter items */
.fitem{display:flex;align-items:center;gap:7px;padding:5px 5px;border-radius:6px;cursor:pointer;transition:background 0.12s;border:none;background:transparent;color:var(--t2);width:100%;font-family:'Syne',sans-serif;font-size:12px;text-align:left;}
.fitem:hover{background:var(--hbg);color:var(--t1);}
.fitem.active{color:var(--t1);}
.ach{width:14px;height:14px;border-radius:4px;border:1.5px solid var(--b3);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all 0.13s;background:var(--s2);}
.fitem.active .ach{background:var(--acc);border-color:var(--acc);}
.ach svg{opacity:0;transition:opacity 0.13s;width:8px;height:8px;stroke:#1a1000;stroke-width:2.5;fill:none;}
.fitem.active .ach svg{opacity:1;}
.fdot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.fcnt{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);}
/* KW */
.kwcloud{display:flex;flex-wrap:wrap;gap:3px;}
.kwtag{padding:2px 6px;background:var(--s2);border:1px solid var(--b2);border-radius:9px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t2);cursor:pointer;transition:all 0.12s;}
.kwtag:hover{border-color:var(--acc);color:var(--acc);}
.kwtag.on{background:var(--acc2);border-color:var(--acc);color:var(--acc);}
/* Palette */
.paltog{cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);transition:color 0.13s;}
.paltog:hover{color:var(--acc);}
.palentry{display:flex;align-items:center;gap:5px;margin-bottom:5px;}
.palthumb{width:22px;height:22px;border-radius:3px;object-fit:cover;border:1px solid var(--b2);}
.palswatches{display:flex;gap:2px;}
.pswatch{width:14px;height:14px;border-radius:2px;cursor:pointer;border:1px solid rgba(128,128,128,0.08);transition:transform 0.1s;}
.pswatch:hover{transform:scale(1.3);}
/* Panel bottom */
.pbtns{padding:8px 12px;border-top:1px solid var(--b1);display:flex;flex-direction:column;gap:4px;}
.pbtn{padding:6px 12px;border-radius:8px;border:1px solid var(--b2);background:transparent;color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;transition:all 0.13s;width:100%;font-weight:500;}
.pbtn:hover{border-color:var(--acc);color:var(--acc);}
.pbtn.pri{background:var(--acc2);border-color:var(--acc);color:var(--acc);}
.pbtn.pri:hover{background:var(--acc);color:#1a1000;}

/* CANVAS WRAP */
.cwrap{flex:1;position:relative;overflow:hidden;}
[data-theme="dark"] .cwrap::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(255,255,255,0.035) 1px,transparent 1px);background-size:22px 22px;pointer-events:none;z-index:0;}
[data-theme="light"] .cwrap::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,rgba(0,0,0,0.06) 1px,transparent 1px);background-size:22px 22px;pointer-events:none;z-index:0;}
.cwrap.pan-mode{cursor:grab;}
.cwrap.panning{cursor:grabbing;}

/* CANVAS TOOLBAR */
.ctb{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:150;display:flex;align-items:center;gap:2px;background:var(--glass);border:1px solid var(--b2);border-radius:11px;padding:4px 5px;backdrop-filter:blur(20px);box-shadow:0 3px 16px var(--shadow);}
.ct{width:30px;height:30px;border-radius:7px;border:none;background:transparent;color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.12s;}
.ct:hover{background:var(--hbg);color:var(--t1);}
.ct.on{background:var(--acc2);color:var(--acc);}
.ctsep{width:1px;height:18px;background:var(--b2);margin:0 2px;}

/* ZOOM CONTROLS */
.zoom-ctrls{position:absolute;bottom:36px;right:14px;z-index:150;display:flex;flex-direction:column;gap:3px;align-items:center;}
.zoom-btn{width:30px;height:30px;border-radius:8px;border:1px solid var(--b2);background:var(--glass);backdrop-filter:blur(14px);color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all 0.13s;font-weight:400;}
.zoom-btn:hover{border-color:var(--b3);color:var(--t1);}
.zoom-btn.special{font-size:11px;font-family:'JetBrains Mono',monospace;}
.zoom-label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);text-align:center;width:100%;}

/* INFINITE CANVAS */
.cvp{position:absolute;inset:0;overflow:hidden;}
.canvas{position:absolute;top:0;left:0;will-change:transform;transform-origin:0 0;}

/* IMAGE CARDS */
.icard{position:absolute;border-radius:9px;border:1px solid var(--cborder);background:var(--s1);box-shadow:0 3px 12px var(--shadow);overflow:visible;cursor:grab;user-select:none;}
.icard:hover,.icard:focus-within{box-shadow:0 6px 22px var(--shadow);z-index:10!important;}
.icard.drag{cursor:grabbing;box-shadow:0 14px 38px var(--shadow);z-index:300!important;opacity:0.94;}
.icard-img{display:block;width:100%;border-radius:8px 8px 0 0;object-fit:cover;background:var(--s2);pointer-events:none;min-height:40px;}
/* Controls outside card */
.icard-top{position:absolute;top:-44px;right:0;opacity:0;transition:opacity 0.18s 0.08s;pointer-events:none;}
.icard-top::after{content:'';position:absolute;bottom:-10px;left:-20px;right:-20px;height:16px;background:transparent;}
.icard:hover .icard-top,.icard:focus-within .icard-top{opacity:1;pointer-events:all;transition:opacity 0.06s 0s;}
.icard-bot{position:absolute;bottom:-40px;left:0;right:0;opacity:0;transition:opacity 0.18s 0.08s;pointer-events:none;}
.icard-bot::before{content:'';position:absolute;top:-10px;left:0;right:0;height:12px;background:transparent;}
.icard:hover .icard-bot,.icard:focus-within .icard-bot{opacity:1;pointer-events:all;transition:opacity 0.06s 0s;}
.cpill{display:inline-flex;align-items:center;gap:2px;background:var(--glass);backdrop-filter:blur(14px);border:1px solid var(--b2);border-radius:18px;padding:3px 7px;box-shadow:0 2px 8px var(--shadow);}
.cpbtn{width:20px;height:20px;border-radius:50%;border:none;background:transparent;color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all 0.12s;flex-shrink:0;}
.cpbtn:hover{background:var(--acc);color:#1a1000;}
.cpbtn.del:hover{background:var(--red);color:white;}
.icard-info{background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--b2);border-radius:7px;padding:4px 7px;display:flex;flex-wrap:wrap;gap:3px;box-shadow:0 2px 7px var(--shadow);max-width:100%;}
.hbadge{padding:2px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:8px;letter-spacing:0.03em;text-transform:uppercase;}
.hb-comp{background:rgba(107,146,176,0.18);color:var(--comp);}
.hb-luz{background:rgba(212,168,90,0.16);color:var(--luz);}
.hb-col{background:rgba(125,184,160,0.16);color:var(--col);}
.hkw{padding:2px 4px;background:var(--s3);border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);}
.rh{position:absolute;bottom:-5px;right:-5px;width:12px;height:12px;border-radius:50%;background:var(--acc);border:2px solid var(--bg);cursor:se-resize;opacity:0;transition:opacity 0.13s;z-index:5;}
.icard:hover .rh{opacity:1;}
.icard.dim,.sticky.dim{opacity:0.16;filter:saturate(0.04);}

/* STICKY NOTES */
.sticky{position:absolute;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.55;cursor:grab;user-select:none;box-shadow:2px 3px 12px var(--shadow);z-index:50;min-width:100px;max-width:185px;}
.sticky:hover,.sticky:focus-within{z-index:80!important;}
.sticky.drag{cursor:grabbing;z-index:350!important;opacity:0.93;}
.sticky-inner{padding:9px 11px;position:relative;}
.sticky-inner::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:rgba(0,0,0,0.1);border-radius:3px 3px 0 0;}
.sticky-text{white-space:pre-wrap;word-break:break-word;}
.sticky-top{position:absolute;top:-40px;right:0;opacity:0;transition:opacity 0.18s 0.1s;pointer-events:none;}
.sticky:hover .sticky-top,.sticky:focus-within .sticky-top{opacity:1;pointer-events:all;transition:opacity 0.06s 0s;}
.sticky-top::after{content:'';position:absolute;bottom:-14px;left:-10px;right:-10px;height:16px;background:transparent;}
.sticky-bot{position:absolute;bottom:-34px;left:0;right:0;opacity:0;transition:opacity 0.18s 0.08s;pointer-events:none;}
.sticky-bot::before{content:'';position:absolute;top:-8px;left:0;right:0;height:10px;background:transparent;}
.sticky:hover .sticky-bot,.sticky:focus-within .sticky-bot{opacity:1;pointer-events:all;transition:opacity 0.06s 0s;}
.sticky-info{background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--b2);border-radius:6px;padding:3px 7px;display:flex;flex-wrap:wrap;gap:3px;font-size:8px;box-shadow:0 2px 7px var(--shadow);}
.sy{background:#f5e86c;color:#2a2010;}
.sp{background:#f5a8ba;color:#2a1018;}
.sb{background:#a8d0f5;color:#101828;}
.sg{background:#a8f0be;color:#102818;}
.so{background:#f5c870;color:#281e08;}

/* CANVAS ELEMENTS */
.cel-title{position:absolute;cursor:grab;z-index:40;user-select:none;}
.cel-title:hover{z-index:60!important;}
.cel-title.drag{cursor:grabbing;}
.cel-title.editing{cursor:text;}
.cel-title.editing .title-text{cursor:text;}
.title-text{font-family:'Playfair Display',serif;font-size:26px;color:var(--t1);padding:4px 6px;border:1px solid transparent;border-radius:4px;outline:none;background:transparent;min-width:60px;display:inline-block;cursor:inherit;}
.cel-title:hover .title-text{border-color:var(--b3);}
.title-ctrls{position:absolute;top:-30px;right:0;opacity:0;transition:opacity 0.14s;}
.cel-title:hover .title-ctrls{opacity:1;}

.cel-box{position:absolute;border-radius:9px;cursor:grab;z-index:3;user-select:none;}
.cel-box:hover{z-index:8!important;}
.cel-box.drag{cursor:grabbing;z-index:350!important;}
.cel-box.sel{outline:2px solid var(--acc);outline-offset:2px;}
.box-handles{position:absolute;inset:-6px;pointer-events:none;display:none;}
.cel-box.sel .box-handles{display:block;}
.bh{position:absolute;width:10px;height:10px;background:var(--s1);border:1.5px solid var(--acc);border-radius:50%;pointer-events:all;}
.bh.tl{top:0;left:0;cursor:nwse-resize;}.bh.tm{top:0;left:50%;transform:translateX(-50%);cursor:ns-resize;}
.bh.tr{top:0;right:0;cursor:nesw-resize;}.bh.ml{top:50%;left:0;transform:translateY(-50%);cursor:ew-resize;}
.bh.mr{top:50%;right:0;transform:translateY(-50%);cursor:ew-resize;}.bh.bl{bottom:0;left:0;cursor:nesw-resize;}
.bh.bm{bottom:0;left:50%;transform:translateX(-50%);cursor:ns-resize;}.bh.br{bottom:0;right:0;cursor:nwse-resize;}
.box-del{position:absolute;top:-32px;right:0;display:none;}
.cel-box.sel .box-del{display:flex;}

/* ARROWS */
#arrowSvg{position:absolute;inset:0;width:5000px;height:4000px;overflow:visible;pointer-events:none;z-index:20;}

/* GRID */
.gvw{position:absolute;inset:0;overflow-y:auto;padding:14px;display:none;background:var(--bg);left:0!important;}
.gvw.on{display:flex;flex-direction:column;gap:0;}
.gtabs{display:flex;gap:2px;background:var(--s2);border-radius:8px;padding:3px;border:1px solid var(--b1);margin-bottom:12px;align-self:flex-start;}
.gtab{padding:5px 14px;border-radius:6px;border:none;background:transparent;color:var(--t3);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.13s;}
.gtab:hover{color:var(--t2);}
.gtab.active{background:var(--s1);color:var(--t1);box-shadow:0 1px 3px var(--shadow);}
.gmas{columns:5;column-gap:5px;flex:1;}
@media(max-width:1400px){.gmas{columns:4;}}
@media(max-width:1100px){.gmas{columns:3;}}
.gcard{break-inside:avoid;margin-bottom:5px;border-radius:8px;border:1px solid var(--b1);background:var(--s1);overflow:hidden;cursor:pointer;position:relative;animation:fadeUp 0.18s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.gcard:hover{border-color:var(--b2);}
.gcard img{width:100%;display:block;}
.gcard-ov{position:absolute;inset:0;background:transparent;display:flex;align-items:center;justify-content:center;opacity:0;transition:all 0.16s;}
.gcard:hover .gcard-ov{opacity:1;background:rgba(0,0,0,0.38);}
.gcard-acts{display:flex;gap:6px;}
.ga-btn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.9);border:none;color:#333;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:transform 0.12s;}
.ga-btn:hover{transform:scale(1.1);}
/* Info below image - hidden until hover */
.gcard-meta{padding:5px 7px;display:flex;flex-wrap:wrap;gap:2px;display:none;}
.gcard:hover .gcard-meta{display:flex;}
.gcard-note{padding:4px 7px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t2);border-top:1px solid var(--b1);display:none;line-height:1.4;}
.gcard:hover .gcard-note{display:block;}
.gnote-above{border-radius:4px 4px 0 0;padding:5px 7px;font-family:'JetBrains Mono',monospace;font-size:9px;line-height:1.4;break-inside:avoid;}
.gfree-note{break-inside:avoid;margin-bottom:5px;border-radius:6px;padding:8px 10px;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.5;cursor:pointer;}
.gnote-standalone{break-inside:avoid;margin-bottom:5px;border-radius:8px;border:1px solid var(--b1);padding:10px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.5;cursor:pointer;}

/* LIGHTBOX */
.lbox{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:2000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px);}
.lbox img{max-width:90vw;max-height:90vh;border-radius:8px;box-shadow:0 20px 60px rgba(0,0,0,0.7);}
.lbox-close{position:absolute;top:18px;right:22px;width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,0.15);border:none;color:white;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.lbox-close:hover{background:rgba(255,255,255,0.25);}

/* EMPTY */
.empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;pointer-events:none;z-index:1;}
.empty h3{font-family:'Playfair Display',serif;font-size:20px;color:var(--t3);}
.empty p{font-size:12px;max-width:240px;text-align:center;line-height:1.6;color:var(--t4);}

/* STATUS BAR */
.sbar{flex-shrink:0;height:24px;border-top:1px solid var(--b1);background:var(--s0);display:flex;align-items:center;padding:0 14px;gap:12px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);}
.ss{color:var(--b3);}

/* LOADER */
.loader{position:fixed;inset:0;background:var(--bg);z-index:3000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.loader h3{font-family:'Playfair Display',serif;font-size:22px;color:var(--t1);}
.loader p{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--t2);}
.spin{width:26px;height:26px;border:2px solid var(--b2);border-top-color:var(--acc);border-radius:50%;animation:spin 0.65s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes su{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}

/* MODALS */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(10px);animation:fi 0.15s ease;}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:13px;padding:20px;width:100%;max-width:460px;box-shadow:0 24px 65px var(--shadow);animation:su 0.18s ease;max-height:90vh;overflow-y:auto;}
.modal h2{font-family:'Playfair Display',serif;font-size:17px;margin-bottom:14px;}
.fg{margin-bottom:11px;}
.fg label{display:block;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t2);text-transform:uppercase;letter-spacing:0.09em;margin-bottom:5px;}
.fg input,.fg textarea{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:7px 10px;color:var(--t1);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color 0.17s;}
.fg input:focus,.fg textarea:focus{border-color:var(--acc);}
.fg textarea{resize:vertical;min-height:54px;}
.mact{display:flex;gap:7px;justify-content:flex-end;margin-top:13px;}
.mbtn{padding:7px 15px;border-radius:7px;border:1px solid var(--b2);background:transparent;color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.13s;}
.mbtn:hover{border-color:var(--b3);color:var(--t1);}
.mbtn.ok{background:var(--acc);border-color:var(--acc);color:#1a1000;font-weight:700;}
.mbtn.ok:hover{opacity:0.88;}
.mbtn.dan{border-color:var(--red);color:var(--red);}
.mbtn.dan:hover{background:var(--red);color:white;}
.tbar{display:flex;gap:2px;background:var(--s2);border-radius:7px;padding:3px;margin-bottom:11px;border:1px solid var(--b1);}
.tb{flex:1;padding:5px;border-radius:5px;border:none;background:transparent;color:var(--t2);font-size:12px;cursor:pointer;transition:all 0.12s;font-family:'Syne',sans-serif;font-weight:500;}
.tb.active{background:var(--s1);color:var(--t1);box-shadow:0 1px 3px var(--shadow);}
.dz{border:2px dashed var(--b2);border-radius:9px;padding:20px;text-align:center;color:var(--t2);font-size:12px;cursor:pointer;transition:all 0.17s;}
.dz:hover,.dz.over{border-color:var(--acc);color:var(--acc);background:var(--acc2);}
.dz input{display:none;}
/* Apple checkboxes */
.cch{display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 6px;border-radius:6px;transition:background 0.11s;white-space:nowrap;}
.cch:hover{background:var(--hbg);}
.cch input[type=checkbox]{display:none;}
.acb{width:14px;height:14px;border-radius:4px;border:1.5px solid var(--b3);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all 0.13s;background:var(--s2);}
.cch input:checked+.acb{background:var(--acc);border-color:var(--acc);}
.acb svg{opacity:0;transition:opacity 0.13s;width:8px;height:8px;stroke:#1a1000;stroke-width:2.5;fill:none;}
.cch input:checked+.acb svg{opacity:1;}
.cch span{font-size:12px;color:var(--t2);}
/* KW input */
.kwwrap{position:relative;}
.kwac{position:absolute;top:100%;left:0;right:0;background:var(--s2);border:1px solid var(--b2);border-radius:7px;z-index:20;display:none;max-height:100px;overflow-y:auto;box-shadow:0 7px 20px var(--shadow);}
.kwac.vis{display:block;}
.kwac-item{padding:6px 10px;cursor:pointer;font-size:12px;color:var(--t2);}
.kwac-item:hover{background:var(--s3);color:var(--t1);}
.kwpills{display:flex;flex-wrap:wrap;gap:3px;margin-top:5px;}
.kwpill{padding:2px 7px;background:var(--s2);border:1px solid var(--b2);border-radius:9px;font-size:11px;display:flex;align-items:center;gap:3px;color:var(--t2);}
.kwpill-x{cursor:pointer;opacity:0.4;font-size:12px;line-height:1;}
.kwpill-x:hover{opacity:1;}
/* Note colors */
.ncrow{display:flex;gap:6px;}
.ncdot{width:18px;height:18px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.12s;}
.ncdot.sel{border-color:white;transform:scale(1.2);}
/* Pinterest */
.pinhint{background:rgba(200,70,70,0.07);border:1px solid rgba(200,70,70,0.2);border-radius:7px;padding:6px 9px;font-size:11px;color:#e08080;display:none;margin-top:5px;line-height:1.5;}
.pinhint.vis{display:block;}
/* Box colors */
.boxcols{display:flex;gap:5px;flex-wrap:wrap;}
.bcol{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.12s;}
.bcol.sel{border-color:var(--acc);transform:scale(1.15);}
/* IO */
.io-json{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:7px;color:var(--t1);font-family:'JetBrains Mono',monospace;font-size:10px;min-height:90px;outline:none;resize:vertical;}
/* Contact sheet */
.cs-preview{background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:10px;margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;min-height:60px;max-height:200px;overflow-y:auto;}
.cs-thumb{width:40px;height:40px;border-radius:3px;object-fit:cover;}
/* Export options */
.expopt{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--b2);border-radius:8px;cursor:pointer;transition:all 0.13s;margin-bottom:6px;}
.expopt:hover,.expopt.sel{border-color:var(--acc);background:var(--acc2);}
.expopt input[type=radio]{display:none;}
.expopt-body{flex:1;}
.expopt-title{font-weight:600;font-size:12px;color:var(--t1);}
.expopt-desc{font-size:10px;color:var(--t3);font-family:'JetBrains Mono',monospace;margin-top:1px;}
.radio-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--b3);flex-shrink:0;transition:all 0.13s;display:flex;align-items:center;justify-content:center;}
.expopt.sel .radio-dot{border-color:var(--acc);}
.radio-dot::after{content:'';width:6px;height:6px;border-radius:50%;background:var(--acc);opacity:0;transition:opacity 0.13s;}
.expopt.sel .radio-dot::after{opacity:1;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px;}
</style>
</head>
<body>
<div class="loader" id="loader"><div class="spin"></div><h3>fr<em style="color:var(--acc);font-style:italic">a</em>me</h3><p id="loaderMsg">Iniciando...</p></div>
<div class="save-ind" id="saveInd"><span class="save-dot" id="saveDot"></span><span id="saveMsg">Guardando...</span></div>

<header>
  <div class="logo">fr<em>a</em>me<span class="logo-ver">v6</span></div>
  <div class="hdiv"></div>
  <div class="vtabs">
    <button class="vtab active" id="vCanvas" onclick="setView('canvas')">Canvas</button>
    <button class="vtab" id="vGrid" onclick="setView('grid')">Grid</button>
  </div>
  <div class="hsp"></div>
  <button class="hpill" onclick="openIO()">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="7 16 12 21 17 16"/><line x1="12" y1="21" x2="12" y2="10"/><polyline points="7 8 12 3 17 8"/></svg>
    Import / Export
  </button>
  <button class="hpill" onclick="openContactSheet()">üìã Hoja Contactos</button>
  <div class="hdiv"></div>
  <button class="drive-pill" id="driveBtn" onclick="driveAuth()"><span class="ddot" id="ddot"></span><span id="driveTxt">Conectar Drive</span></button>
  <button class="thm-btn" onclick="toggleTheme()"><div class="thm-half-b"></div><div class="thm-half-w"></div></button>
  <button class="hpill" onclick="openNoteModal()">üìù Nota</button>
  <button class="hpill acc" onclick="openAddModal()">+ Imagen</button>
</header>

<div class="pbar" id="pbar"></div>

<div class="main">
  <div class="panel">
    <div class="pbody">
      <div class="psec">
        <div class="ptitle">Categor√≠as <span class="pclr" onclick="clearCats()">limpiar</span></div>
        <div style="display:flex;flex-direction:column;gap:2px">
          <button class="fitem active" data-cat="all" onclick="toggleCat('all')"><span class="ach"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></span><span class="fdot" style="background:var(--t4)"></span>Todo<span class="fcnt" id="fc-all">0</span></button>
          <button class="fitem" data-cat="composicion" onclick="toggleCat('composicion')"><span class="ach"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></span><span class="fdot" style="background:var(--comp)"></span>Composici√≥n<span class="fcnt" id="fc-composicion">0</span></button>
          <button class="fitem" data-cat="iluminacion" onclick="toggleCat('iluminacion')"><span class="ach"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></span><span class="fdot" style="background:var(--luz)"></span>Iluminaci√≥n<span class="fcnt" id="fc-iluminacion">0</span></button>
          <button class="fitem" data-cat="color" onclick="toggleCat('color')"><span class="ach"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></span><span class="fdot" style="background:var(--col)"></span>Paleta de color<span class="fcnt" id="fc-color">0</span></button>
        </div>
      </div>
      <div class="psec">
        <div class="ptitle">Keywords <span class="pclr" onclick="clearKws()">limpiar</span></div>
        <div class="kwcloud" id="kwCloud"><span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4)">Sin keywords a√∫n</span></div>
      </div>
      <div class="psec">
        <div class="ptitle">Paletas <span class="paltog" id="palTog" onclick="togglePal()">‚ñ∏ ver</span></div>
        <div id="palContent" style="display:none"><div id="palEntries"></div></div>
      </div>
    </div>
    <div class="pbtns">
      <button class="pbtn pri" onclick="openAddModal()">+ Nueva imagen</button>
      <button class="pbtn" onclick="openNoteModal()">+ Nota suelta</button>
    </div>
  </div>

  <div class="cwrap" id="cwrap">
    <div class="ctb" id="ctb">
      <button class="ct on" id="tool-select" onclick="setTool('select')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-7 1-3 7z"/></svg></button>
      <button class="ct" id="tool-pan" onclick="setTool('pan')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-4 0v5M14 10V4a2 2 0 0 0-4 0v2M10 10.5V6a2 2 0 0 0-4 0v8M6 14a4 4 0 0 0 4 4h4a4 4 0 0 0 4-4v-2.5"/></svg></button>
      <div class="ctsep"></div>
      <button class="ct" id="tool-title" onclick="setTool('title')"><span style="font-family:'Playfair Display',serif;font-size:14px;font-weight:600;line-height:1">T</span></button>
      <button class="ct" id="tool-box" onclick="setTool('box')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/></svg></button>
      <button class="ct" id="tool-arrow" onclick="setTool('arrow')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
    </div>
    <!-- ZOOM CONTROLS -->
    <div class="zoom-ctrls" id="zoomCtrls">
      <button class="zoom-btn" onclick="zoomIn()">+</button>
      <div class="zoom-label" id="zoomLbl">100%</div>
      <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
      <button class="zoom-btn special" onclick="fitAll()" title="Ver todo">‚ä°</button>
    </div>
    <div class="cvp" id="cvp">
      <div class="canvas" id="canvas">
        <svg id="arrowSvg" style="position:absolute;inset:0;width:5000px;height:4000px;overflow:visible;pointer-events:none;z-index:20;">
          <defs><marker id="ah" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto"><path d="M0,0 L10,4 L0,8 Z" fill="#d4a85a"/></marker></defs>
        </svg>
      </div>
    </div>
    <div class="gvw" id="gvw">
      <div class="gtabs">
        <button class="gtab active" data-gt="all" onclick="setGridTab('all')">Todo</button>
        <button class="gtab" data-gt="images" onclick="setGridTab('images')">Im√°genes</button>
        <button class="gtab" data-gt="notes" onclick="setGridTab('notes')">Notas</button>
      </div>
      <div class="gmas" id="gmas"></div>
    </div>
    <div class="empty" id="emptySt"><div style="font-size:36px;opacity:0.08">üéû</div><h3>Canvas vac√≠o</h3><p>A√±ade im√°genes o notas para construir el mood.</p></div>
  </div>
</div>

<div class="sbar"><span id="sbProj">‚Äî</span><span class="ss">¬∑</span><span id="sbImgs">0 imgs</span><span class="ss">¬∑</span><span id="sbNotes">0 notas</span><span class="ss">¬∑</span><span id="sbZoom">100%</span><span style="margin-left:auto" id="sbDrive">Local</span></div>

<!-- ADD IMAGE -->
<div class="mbg" id="addModal" style="display:none"><div class="modal">
  <h2>Nueva referencia visual</h2>
  <div class="tbar"><button class="tb active" id="tabUrl" onclick="switchAddTab('url')">üîó URL</button><button class="tb" id="tabFile" onclick="switchAddTab('file')">üìÅ Archivo</button></div>
  <div id="urlTab"><div class="fg"><label>URL de imagen</label><input type="text" id="imgUrl" placeholder="https://..." oninput="checkPin(this.value)"><div class="pinhint" id="pinHint">‚ö†Ô∏è Pinterest bloquea carga directa. Descarga y sube como archivo.</div></div></div>
  <div id="fileTab" style="display:none"><div class="dz" id="dz" onclick="document.getElementById('fileIn').click()"><div style="font-size:24px;margin-bottom:5px">üñº</div><div>Arrastra o haz clic</div><div style="font-size:10px;color:var(--t4);margin-top:2px">JPG ¬∑ PNG ¬∑ WEBP ¬∑ GIF</div><input type="file" id="fileIn" accept="image/*" onchange="handleFile(event)"></div><div id="fileName" style="font-size:11px;color:var(--t2);margin-top:5px;text-align:center"></div></div>
  <div class="fg" style="margin-top:11px"><label>Categor√≠as</label><div style="display:flex;flex-direction:column;gap:3px">
    <label class="cch"><input type="checkbox" value="composicion" class="imgCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Composici√≥n / Encuadre</span></label>
    <label class="cch"><input type="checkbox" value="iluminacion" class="imgCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Iluminaci√≥n</span></label>
    <label class="cch"><input type="checkbox" value="color" class="imgCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Paleta de color</span></label>
  </div></div>
  <div class="fg"><label>Keywords <span style="font-size:9px;color:var(--t4)">(coma para a√±adir)</span></label><div class="kwwrap"><input type="text" id="kwIn" placeholder="gran angular, contraluz..." oninput="kwAc('kwIn','kwAcBox',addKws)" onkeydown="kwKey(event,'kwIn','kwAcBox',addKws,'kwPills')"><div class="kwac" id="kwAcBox"></div></div><div class="kwpills" id="kwPills"></div></div>
  <div class="fg"><label>Nota</label><textarea id="imgNote" placeholder="¬øQu√© te inspira?"></textarea></div>
  <div class="mact"><button class="mbtn" onclick="closeModal('addModal')">Cancelar</button><button class="mbtn ok" onclick="addImage()">A√±adir</button></div>
</div></div>

<!-- NOTE -->
<div class="mbg" id="noteModal" style="display:none"><div class="modal" style="max-width:400px">
  <h2>Nueva nota</h2>
  <div class="fg"><label>Texto</label><textarea id="noteTxt" style="min-height:80px"></textarea></div>
  <div class="fg"><label>Categor√≠as</label><div style="display:flex;flex-direction:column;gap:3px">
    <label class="cch"><input type="checkbox" value="composicion" class="noteCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Composici√≥n</span></label>
    <label class="cch"><input type="checkbox" value="iluminacion" class="noteCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Iluminaci√≥n</span></label>
    <label class="cch"><input type="checkbox" value="color" class="noteCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Color</span></label>
  </div></div>
  <div class="fg"><label>Keywords</label><div class="kwwrap"><input type="text" id="nkwIn" oninput="kwAc('nkwIn','nkwAc',noteKws)" onkeydown="kwKey(event,'nkwIn','nkwAc',noteKws,'nkwPills')"><div class="kwac" id="nkwAc"></div></div><div class="kwpills" id="nkwPills"></div></div>
  <div class="fg"><label>Color</label><div class="ncrow"><div class="ncdot sel" style="background:#f5e86c" data-c="sy" onclick="selNC(this,'noteModal')"></div><div class="ncdot" style="background:#f5a8ba" data-c="sp" onclick="selNC(this,'noteModal')"></div><div class="ncdot" style="background:#a8d0f5" data-c="sb" onclick="selNC(this,'noteModal')"></div><div class="ncdot" style="background:#a8f0be" data-c="sg" onclick="selNC(this,'noteModal')"></div><div class="ncdot" style="background:#f5c870" data-c="so" onclick="selNC(this,'noteModal')"></div></div></div>
  <div class="mact"><button class="mbtn" onclick="closeModal('noteModal')">Cancelar</button><button class="mbtn ok" onclick="addNote()">A√±adir</button></div>
</div></div>

<!-- EDIT IMAGE -->
<div class="mbg" id="editImgModal" style="display:none"><div class="modal">
  <h2>Editar imagen</h2><input type="hidden" id="eImgId">
  <div class="fg"><label>Categor√≠as</label><div style="display:flex;flex-direction:column;gap:3px">
    <label class="cch"><input type="checkbox" value="composicion" class="eCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Composici√≥n</span></label>
    <label class="cch"><input type="checkbox" value="iluminacion" class="eCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Iluminaci√≥n</span></label>
    <label class="cch"><input type="checkbox" value="color" class="eCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Color</span></label>
  </div></div>
  <div class="fg"><label>Keywords</label><div class="kwwrap"><input type="text" id="ekwIn" oninput="kwAc('ekwIn','ekwAc',editKws)" onkeydown="kwKey(event,'ekwIn','ekwAc',editKws,'ekwPills')"><div class="kwac" id="ekwAc"></div></div><div class="kwpills" id="ekwPills"></div></div>
  <div class="fg"><label>Nota</label><textarea id="eImgNote"></textarea></div>
  <div class="mact"><button class="mbtn dan" onclick="delImgEdit()">Eliminar</button><button class="mbtn" onclick="closeModal('editImgModal')">Cancelar</button><button class="mbtn ok" onclick="saveImgEdit()">Guardar</button></div>
</div></div>

<!-- EDIT NOTE -->
<div class="mbg" id="editNoteModal" style="display:none"><div class="modal" style="max-width:400px">
  <h2>Editar nota</h2><input type="hidden" id="eNoteId">
  <div class="fg"><label>Texto</label><textarea id="eNoteTxt" style="min-height:80px"></textarea></div>
  <div class="fg"><label>Categor√≠as</label><div style="display:flex;flex-direction:column;gap:3px">
    <label class="cch"><input type="checkbox" value="composicion" class="eNoteCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Composici√≥n</span></label>
    <label class="cch"><input type="checkbox" value="iluminacion" class="eNoteCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Iluminaci√≥n</span></label>
    <label class="cch"><input type="checkbox" value="color" class="eNoteCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Color</span></label>
  </div></div>
  <div class="fg"><label>Keywords</label><div class="kwwrap"><input type="text" id="enkwIn" oninput="kwAc('enkwIn','enkwAc',editNoteKws)" onkeydown="kwKey(event,'enkwIn','enkwAc',editNoteKws,'enkwPills')"><div class="kwac" id="enkwAc"></div></div><div class="kwpills" id="enkwPills"></div></div>
  <div class="fg"><label>Color</label><div class="ncrow" id="eNoteColors"><div class="ncdot" style="background:#f5e86c" data-c="sy" onclick="selNC(this,'eNoteColors')"></div><div class="ncdot" style="background:#f5a8ba" data-c="sp" onclick="selNC(this,'eNoteColors')"></div><div class="ncdot" style="background:#a8d0f5" data-c="sb" onclick="selNC(this,'eNoteColors')"></div><div class="ncdot" style="background:#a8f0be" data-c="sg" onclick="selNC(this,'eNoteColors')"></div><div class="ncdot" style="background:#f5c870" data-c="so" onclick="selNC(this,'eNoteColors')"></div></div></div>
  <div class="mact"><button class="mbtn dan" onclick="delNoteEdit()">Eliminar</button><button class="mbtn" onclick="closeModal('editNoteModal')">Cancelar</button><button class="mbtn ok" onclick="saveNoteEdit()">Guardar</button></div>
</div></div>

<!-- BOX -->
<div class="mbg" id="boxModal" style="display:none"><div class="modal" style="max-width:320px">
  <h2>Nueva caja</h2>
  <div class="fg"><label>Color de fondo</label><div class="boxcols" id="boxCols"><div class="bcol sel" style="background:#1a1a2e" data-col="#1a1a2e" onclick="selBCol(this)"></div><div class="bcol" style="background:#2a1a0e" data-col="#2a1a0e" onclick="selBCol(this)"></div><div class="bcol" style="background:#0e2a1a" data-col="#0e2a1a" onclick="selBCol(this)"></div><div class="bcol" style="background:#2a0e1a" data-col="#2a0e1a" onclick="selBCol(this)"></div><div class="bcol" style="background:#2d2416" data-col="#2d2416" onclick="selBCol(this)"></div><div class="bcol" style="background:#1e2a2a" data-col="#1e2a2a" onclick="selBCol(this)"></div><div class="bcol" style="background:#e8e4dc" data-col="#e8e4dc" onclick="selBCol(this)"></div><div class="bcol" style="background:#f5f0e8" data-col="#f5f0e8" onclick="selBCol(this)"></div></div><div style="margin-top:8px"><input type="color" id="boxCustom" value="#1a1a2e" style="width:100%;height:32px;border-radius:6px;border:1px solid var(--b2);cursor:pointer;background:var(--s2);padding:2px"></div></div>
  <div class="mact"><button class="mbtn" onclick="closeModal('boxModal')">Cancelar</button><button class="mbtn ok" onclick="placeBox()">Crear</button></div>
</div></div>

<!-- PROJECT -->
<div class="mbg" id="projModal" style="display:none"><div class="modal" style="max-width:320px">
  <h2>Nuevo proyecto</h2>
  <div class="fg"><label>Nombre</label><input type="text" id="projIn" placeholder="Cortometraje 2025..." onkeydown="if(event.key==='Enter')createProj()"></div>
  <div class="mact"><button class="mbtn" onclick="closeModal('projModal')">Cancelar</button><button class="mbtn ok" onclick="createProj()">Crear</button></div>
</div></div>

<!-- IO -->
<div class="mbg" id="ioModal" style="display:none"><div class="modal" style="max-width:480px">
  <h2>Import / Export</h2>
  <div class="tbar"><button class="tb active" id="ioExp" onclick="switchIO('export')">Exportar</button><button class="tb" id="ioImp" onclick="switchIO('import')">Importar</button></div>
  <div id="ioExportSec">
    <p style="font-size:12px;color:var(--t2);margin-bottom:12px;line-height:1.6">Elige qu√© exportar. Las im√°genes en base64 pueden generar archivos grandes.</p>
    <div class="expopt sel" id="expOptDb" onclick="selExpOpt('db')"><div class="radio-dot"></div><div class="expopt-body"><div class="expopt-title">Base de datos</div><div class="expopt-desc">Proyectos, notas, posiciones, keywords. Sin im√°genes.</div></div></div>
    <div class="expopt" id="expOptImg" onclick="selExpOpt('img')"><div class="radio-dot"></div><div class="expopt-body"><div class="expopt-title">Solo im√°genes</div><div class="expopt-desc">Exporta las im√°genes locales (base64). Solo im√°genes sin Drive URL.</div></div></div>
    <div class="expopt" id="expOptAll" onclick="selExpOpt('all')"><div class="radio-dot"></div><div class="expopt-body"><div class="expopt-title">Todo (base de datos + im√°genes)</div><div class="expopt-desc">Exportaci√≥n completa. Archivo grande.</div></div></div>
    <button class="mbtn ok" style="width:100%;margin-top:10px" onclick="doExport()">‚Üì Descargar JSON</button>
  </div>
  <div id="ioImportSec" style="display:none">
    <p style="font-size:12px;color:var(--t2);margin-bottom:10px;line-height:1.6">Importa un JSON exportado desde Frame. Los datos existentes se combinar√°n.</p>
    <div class="fg"><label>JSON de Frame</label><textarea class="io-json" id="importJson" placeholder='{"projects":[...],...}'></textarea></div>
    <button class="mbtn ok" style="width:100%" onclick="doImport()">Importar proyecto</button>
  </div>
  <div class="mact"><button class="mbtn" onclick="closeModal('ioModal')">Cerrar</button></div>
</div></div>

<!-- CONTACT SHEET -->
<div class="mbg" id="csModal" style="display:none"><div class="modal" style="max-width:520px">
  <h2>Hoja de contactos</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <div class="fg"><label>Formato</label>
      <select id="csFmt" style="width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:7px 10px;color:var(--t1);font-family:'Syne',sans-serif;outline:none">
        <option value="a4">A4</option><option value="a3">A3</option>
      </select>
    </div>
    <div class="fg"><label>Orientaci√≥n</label>
      <select id="csOrient" style="width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:7px 10px;color:var(--t1);font-family:'Syne',sans-serif;outline:none">
        <option value="landscape">Horizontal</option><option value="portrait">Vertical</option>
      </select>
    </div>
    <div class="fg"><label>Columnas</label><input type="number" id="csCols" value="4" min="1" max="8"></div>
    <div class="fg"><label>Filas por p√°gina</label><input type="number" id="csRows" value="5" min="1" max="10"></div>
  </div>
  <div class="fg"><label>Mostrar anotaci√≥n</label>
    <div style="display:flex;gap:10px;margin-top:3px">
      <label class="cch"><input type="checkbox" id="csShowNote" checked><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Nota / descripci√≥n</span></label>
      <label class="cch"><input type="checkbox" id="csShowKw" checked><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Keywords</span></label>
    </div>
  </div>
  <div class="fg"><label>Filtrar por categor√≠a (dejar vac√≠o = todo)</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:3px">
      <label class="cch"><input type="checkbox" value="composicion" class="csCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Composici√≥n</span></label>
      <label class="cch"><input type="checkbox" value="iluminacion" class="csCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Iluminaci√≥n</span></label>
      <label class="cch"><input type="checkbox" value="color" class="csCat"><div class="acb"><svg viewBox="0 0 10 10"><polyline points="1.5,5 4,8 8.5,2"/></svg></div><span>Color</span></label>
    </div>
  </div>
  <div class="fg"><label>Filtrar por keyword (opcional)</label><input type="text" id="csKwFilter" placeholder="gran angular, noche..."></div>
  <div class="fg"><label>T√≠tulo del documento</label><input type="text" id="csTitle" placeholder="Frame ‚Äî Referentes visuales"></div>
  <div style="background:var(--s2);border-radius:7px;padding:8px;margin-bottom:10px">
    <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);margin-bottom:5px">PREVISUALIZACI√ìN</div>
    <div id="csPreview" style="display:flex;flex-wrap:wrap;gap:3px;min-height:40px"></div>
    <div id="csCount" style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);margin-top:5px"></div>
  </div>
  <div class="mact"><button class="mbtn" onclick="closeModal('csModal')">Cancelar</button><button class="mbtn ok" onclick="generateContactSheet()">üìÑ Generar PDF</button></div>
</div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const CLIENT_ID='1084073419079-j6v6s95h5lap3n6brv5c97g7ip2ubedl.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.file';
let tokenClient=null,accessToken=null,rootFolderId=null,dataFileId=null;
let saving=false,saveQ=false,saveTimer=null;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const DEF='Mi proyecto';
let S={projects:[DEF],active:DEF,images:{},notes:{},titles:{},boxes:{},arrows:{},filter:{cats:[],kws:[]},view:'canvas',theme:'dark'};
const I=()=>{if(!S.images[S.active])S.images[S.active]=[];return S.images[S.active];};
const N=()=>{if(!S.notes[S.active])S.notes[S.active]=[];return S.notes[S.active];};
const T=()=>{if(!S.titles[S.active])S.titles[S.active]=[];return S.titles[S.active];};
const B=()=>{if(!S.boxes[S.active])S.boxes[S.active]=[];return S.boxes[S.active];};
const AR=()=>{if(!S.arrows[S.active])S.arrows[S.active]=[];return S.arrows[S.active];};
function allKws(){const s=new Set();I().forEach(im=>(im.keywords||[]).forEach(k=>s.add(k)));N().forEach(n=>(n.keywords||[]).forEach(k=>s.add(k)));return[...s].sort();}

// ‚îÄ‚îÄ SAVE INDICATOR ‚îÄ‚îÄ
function showSaving(){
  const ind=document.getElementById('saveInd');
  document.getElementById('saveDot').style.display='';
  document.getElementById('saveMsg').textContent='Guardando...';
  ind.classList.add('vis');
  clearTimeout(saveTimer);
}
function showSaved(){
  const ind=document.getElementById('saveInd');
  document.getElementById('saveDot').style.display='none';
  document.getElementById('saveMsg').innerHTML='<span style="color:var(--green);font-size:14px">‚úì</span> Guardado';
  clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>ind.classList.remove('vis'),2200);
}
function showSavedLocal(){
  document.getElementById('sbDrive').textContent=accessToken?'Drive ‚úì':'Local ‚úì';
}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
function toggleTheme(){
  const t=document.documentElement.dataset.theme==='dark'?'light':'dark';
  document.documentElement.dataset.theme=t;S.theme=t;save();
}

// ‚îÄ‚îÄ ZOOM ‚îÄ‚îÄ
let panX=0,panY=0,zoomLevel=1;
const ZOOM_MIN=0.15,ZOOM_MAX=3,ZOOM_STEP=0.15;

function applyTrans(){
  document.getElementById('canvas').style.transform=`translate(${panX}px,${panY}px) scale(${zoomLevel})`;
  const pct=Math.round(zoomLevel*100)+'%';
  document.getElementById('zoomLbl').textContent=pct;
  document.getElementById('sbZoom').textContent=pct;
}
function zoomIn(){setZoom(zoomLevel+ZOOM_STEP);}
function zoomOut(){setZoom(zoomLevel-ZOOM_STEP);}
function setZoom(z,cx,cy){
  const vp=document.getElementById('cvp');const rect=vp.getBoundingClientRect();
  const ox=cx??rect.width/2,oy=cy??rect.height/2;
  const newZ=Math.min(ZOOM_MAX,Math.max(ZOOM_MIN,z));
  const ratio=newZ/zoomLevel;
  panX=ox-(ox-panX)*ratio;
  panY=oy-(oy-panY)*ratio;
  zoomLevel=newZ;applyTrans();
}
function fitAll(){
  const imgs=I();if(!imgs.length&&!N().length){panX=0;panY=0;zoomLevel=1;applyTrans();return;}
  const all=[...imgs,...N(),...T(),...B()];
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  all.forEach(el=>{minX=Math.min(minX,el.x);minY=Math.min(minY,el.y);maxX=Math.max(maxX,(el.x||0)+(el.w||200));maxY=Math.max(maxY,(el.y||0)+(el.h||150));});
  const vp=document.getElementById('cvp');const vr=vp.getBoundingClientRect();
  const pw=maxX-minX+80,ph=maxY-minY+80;
  const z=Math.min(ZOOM_MAX,Math.max(ZOOM_MIN,Math.min(vr.width/pw,vr.height/ph)*0.92));
  zoomLevel=z;panX=vr.width/2-((minX+maxX)/2)*z;panY=vr.height/2-((minY+maxY)/2)*z;applyTrans();
}

// ‚îÄ‚îÄ PAN ‚îÄ‚îÄ
let isPan=false,panSx=0,panSy=0,panOx=0,panOy=0;
let activeTool='select',spaceDown=false;
const cvp=document.getElementById('cvp');

cvp.addEventListener('mousedown',e=>{
  if((activeTool==='pan'||spaceDown)&&e.button===0){
    isPan=true;document.getElementById('cwrap').classList.add('panning');
    panSx=e.clientX;panSy=e.clientY;panOx=panX;panOy=panY;e.preventDefault();
  }
});
document.addEventListener('mousemove',e=>{if(isPan){panX=panOx+(e.clientX-panSx);panY=panOy+(e.clientY-panSy);applyTrans();}});
document.addEventListener('mouseup',()=>{if(isPan){isPan=false;document.getElementById('cwrap').classList.remove('panning');}});

// Wheel zoom
cvp.addEventListener('wheel',e=>{
  e.preventDefault();
  const rect=cvp.getBoundingClientRect();
  setZoom(zoomLevel*(e.deltaY<0?1.08:0.93),e.clientX-rect.left,e.clientY-rect.top);
},{passive:false});

document.addEventListener('keydown',e=>{
  if(e.code==='Space'&&!e.target.matches('input,textarea,[contenteditable]')){spaceDown=true;document.getElementById('cwrap').classList.add('pan-mode');e.preventDefault();}
  if(e.key==='Escape'){document.querySelectorAll('.mbg').forEach(b=>b.style.display='none');setTool('select');}
  if((e.metaKey||e.ctrlKey)&&e.key==='i'){e.preventDefault();openAddModal();}
  if((e.metaKey||e.ctrlKey)&&e.key==='n'){e.preventDefault();openNoteModal();}
  if((e.metaKey||e.ctrlKey)&&e.key==='='){e.preventDefault();zoomIn();}
  if((e.metaKey||e.ctrlKey)&&e.key==='-'){e.preventDefault();zoomOut();}
  if((e.metaKey||e.ctrlKey)&&e.key==='0'){e.preventDefault();setZoom(1);}
});
document.addEventListener('keyup',e=>{if(e.code==='Space'){spaceDown=false;if(activeTool!=='pan')document.getElementById('cwrap').classList.remove('pan-mode');}});

function setTool(t){
  activeTool=t;
  document.querySelectorAll('.ct').forEach(b=>b.classList.remove('on'));
  document.getElementById('tool-'+t)?.classList.add('on');
  const w=document.getElementById('cwrap');
  w.classList.toggle('pan-mode',t==='pan');
  if(t==='box')openModal('boxModal');
  else if(t==='title')placeTitleClick();
  else if(t==='arrow')startArrow();
}

// ‚îÄ‚îÄ DRIVE ‚îÄ‚îÄ
function initDrive(){
  if(typeof google==='undefined')return;
  // Try auto-reconnect using hint
  const hint=localStorage.getItem('frame_drive_hint');
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID,scope:SCOPES,
    hint:hint||undefined,
    callback:async r=>{
      if(r.error){setDriveUI(false);return;}
      accessToken=r.access_token;
      if(r.hint)localStorage.setItem('frame_drive_hint',r.hint);
      setDriveUI(true);
      await initDriveFolder();await loadFromDrive();
    }
  });
  // Try silent reconnect on load
  if(hint){
    tokenClient.requestAccessToken({prompt:''});
  }
}
function driveAuth(){
  if(!tokenClient)return;
  tokenClient.requestAccessToken({prompt:'consent'});
}
function setDriveUI(ok){
  const btn=document.getElementById('driveBtn');
  btn.classList.toggle('ok',ok);
  document.getElementById('driveTxt').textContent=ok?'Drive conectado':'Conectar Drive';
  document.getElementById('sbDrive').textContent=ok?'Drive':'Local';
}
async function driveReq(url,opts={}){
  const r=await fetch(url,{...opts,headers:{Authorization:`Bearer ${accessToken}`,...(opts.headers||{})}});
  if(!r.ok)throw new Error('Drive '+r.status);return r;
}
async function initDriveFolder(){
  const q=`name='Frame' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
  const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  const d=await r.json();
  if(d.files&&d.files.length){rootFolderId=d.files[0].id;return;}
  const cr=await driveReq('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:'Frame',mimeType:'application/vnd.google-apps.folder'})});
  rootFolderId=(await cr.json()).id;
}
async function loadFromDrive(){
  setLoader(true,'Cargando desde Drive...');
  try{
    const q=`name='frame_data.json' and '${rootFolderId}' in parents and trashed=false`;
    const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
    const d=await r.json();
    if(d.files&&d.files.length){
      dataFileId=d.files[0].id;
      const fr=await driveReq(`https://www.googleapis.com/drive/v3/files/${dataFileId}?alt=media`);
      const saved=await fr.json();
      ['projects','images','notes','titles','boxes','arrows'].forEach(k=>{if(saved[k])S[k]=saved[k];});
      if(saved.active&&S.projects.includes(saved.active))S.active=saved.active;
    }
  }catch(e){console.error('Load:',e);}
  setLoader(false);renderAll();
}
async function save(){
  if(saving){saveQ=true;return;}saving=true;
  showSaving();
  try{
    const str=JSON.stringify(S);
    // Always save to localStorage
    try{localStorage.setItem('frame_v6',str);}catch(e){}
    if(accessToken&&rootFolderId){
      const blob=new Blob([str],{type:'application/json'});
      if(dataFileId){
        await driveReq(`https://www.googleapis.com/upload/drive/v3/files/${dataFileId}?uploadType=media`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:blob});
      }else{
        const meta={name:'frame_data.json',parents:[rootFolderId]};
        const form=new FormData();form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));form.append('file',blob);
        const res=await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',body:form});
        dataFileId=(await res.json()).id;
      }
    }
    showSaved();
  }catch(e){console.error('Save:',e);showSaved();}
  saving=false;if(saveQ){saveQ=false;save();}
}
async function uploadImg(b64,fname,proj,cats){
  if(!accessToken||!rootFolderId)return null;
  try{
    const pfId=await mkFolder(proj,rootFolderId);const cfId=await mkFolder(cats[0]||'general',pfId);
    const bin=atob(b64.split(',')[1]);const ab=new ArrayBuffer(bin.length);const ia=new Uint8Array(ab);
    for(let i=0;i<bin.length;i++)ia[i]=bin.charCodeAt(i);
    const blob=new Blob([ab],{type:b64.split(';')[0].split(':')[1]});
    const meta={name:fname,parents:[cfId]};const form=new FormData();
    form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));form.append('file',blob);
    const res=await driveReq('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',body:form});
    const f=await res.json();
    await driveReq(`https://www.googleapis.com/drive/v3/files/${f.id}/permissions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role:'reader',type:'anyone'})});
    return`https://drive.google.com/thumbnail?id=${f.id}&sz=w1000`;
  }catch(e){return null;}
}
async function mkFolder(name,parent){
  const q=`name='${name}' and '${parent}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
  const r=await driveReq(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  const d=await r.json();if(d.files&&d.files.length)return d.files[0].id;
  const cr=await driveReq('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,mimeType:'application/vnd.google-apps.folder',parents:[parent]})});
  return(await cr.json()).id;
}

// ‚îÄ‚îÄ VIEW ‚îÄ‚îÄ
function setView(v){
  S.view=v;
  document.getElementById('vCanvas').classList.toggle('active',v==='canvas');
  document.getElementById('vGrid').classList.toggle('active',v==='grid');
  document.getElementById('cvp').style.display=v==='canvas'?'':'none';
  document.getElementById('ctb').style.display=v==='canvas'?'':'none';
  document.getElementById('zoomCtrls').style.display=v==='canvas'?'':'none';
  document.getElementById('gvw').classList.toggle('on',v==='grid');
  document.getElementById('emptySt').style.display='none';
  if(v==='grid')renderGrid();else renderCanvas();
}

// ‚îÄ‚îÄ GRID TAB ‚îÄ‚îÄ
let gridTab='all';
function setGridTab(t){
  gridTab=t;
  document.querySelectorAll('.gtab').forEach(el=>el.classList.toggle('active',el.dataset.gt===t));
  renderGrid();
}

// ‚îÄ‚îÄ PROJECTS ‚îÄ‚îÄ
function renderProjBar(){
  const bar=document.getElementById('pbar');bar.innerHTML='';
  S.projects.forEach(p=>{
    const c=document.createElement('button');c.className='pchip'+(p===S.active?' active':'');
    c.innerHTML=`<span>${esc(p)}</span>`;
    if(p!==S.active){const d=document.createElement('span');d.className='pdel';d.textContent='√ó';d.onclick=ev=>{ev.stopPropagation();delProj(p);};c.appendChild(d);}
    c.onclick=ev=>{if(ev.target.classList.contains('pdel'))return;switchProj(p);};bar.appendChild(c);
  });
  const a=document.createElement('button');a.className='pchip newp';a.textContent='+ Proyecto';
  a.onclick=()=>{document.getElementById('projIn').value='';openModal('projModal');};bar.appendChild(a);
}
function switchProj(p){S.active=p;S.filter={cats:[],kws:[]};save();renderAll();}
function createProj(){
  const n=document.getElementById('projIn').value.trim();if(!n)return;
  if(!S.projects.includes(n))S.projects.push(n);
  switchProj(n);closeModal('projModal');
}
function delProj(p){
  if(!confirm(`¬øEliminar "${p}"?`))return;
  S.projects=S.projects.filter(x=>x!==p);
  ['images','notes','titles','boxes','arrows'].forEach(k=>delete S[k][p]);
  if(S.active===p)S.active=S.projects[0]||DEF;
  save();renderAll();
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function toggleCat(c){
  if(c==='all'){S.filter.cats=[];}
  else{const i=S.filter.cats.indexOf(c);if(i>=0)S.filter.cats.splice(i,1);else S.filter.cats.push(c);}
  updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();
}
function clearCats(){S.filter.cats=[];updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();}
function clearKws(){S.filter.kws=[];updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();}
function toggleKw(k){const i=S.filter.kws.indexOf(k);if(i>=0)S.filter.kws.splice(i,1);else S.filter.kws.push(k);updateFilterUI();renderCanvas();if(S.view==='grid')renderGrid();}
function updateFilterUI(){
  document.querySelectorAll('.fitem').forEach(el=>{const c=el.dataset.cat;const ok=c==='all'?S.filter.cats.length===0:S.filter.cats.includes(c);el.classList.toggle('active',ok);});
  document.querySelectorAll('.kwtag').forEach(el=>el.classList.toggle('on',S.filter.kws.includes(el.dataset.kw)));
  updateCounts();
}
function matches(item){
  const cats=item.categories||[];
  const catOk=S.filter.cats.length===0||cats.some(c=>S.filter.cats.includes(c));
  const kwOk=S.filter.kws.length===0||S.filter.kws.some(k=>(item.keywords||[]).includes(k));
  return catOk&&kwOk;
}
function hasFilter(){return S.filter.cats.length>0||S.filter.kws.length>0;}

// ‚îÄ‚îÄ KW CLOUD ‚îÄ‚îÄ
function renderKwCloud(){
  const c=document.getElementById('kwCloud');const kws=allKws();
  c.innerHTML=kws.length?kws.map(k=>`<span class="kwtag${S.filter.kws.includes(k)?' on':''}" data-kw="${esc(k)}" onclick="toggleKw('${esc(k)}')">${esc(k)}</span>`).join(''):'<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">Sin keywords a√∫n</span>';
}

// ‚îÄ‚îÄ ADD IMAGE ‚îÄ‚îÄ
let addTab='url',fileData=null,addKws=[];
function openAddModal(){
  addKws=[];fileData=null;
  ['imgUrl','imgNote','kwIn'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('kwPills').innerHTML='';document.getElementById('fileName').textContent='';
  document.getElementById('pinHint').classList.remove('vis');
  document.querySelectorAll('.imgCat').forEach(c=>c.checked=false);
  switchAddTab('url');openModal('addModal');
}
function switchAddTab(t){
  addTab=t;
  document.getElementById('urlTab').style.display=t==='url'?'':'none';
  document.getElementById('fileTab').style.display=t==='file'?'':'none';
  document.getElementById('tabUrl').classList.toggle('active',t==='url');
  document.getElementById('tabFile').classList.toggle('active',t==='file');
}
function checkPin(v){document.getElementById('pinHint').classList.toggle('vis',v.includes('pinterest')||v.includes('pin.it')||v.includes('pinimg'));}
function handleFile(e){const f=e.target.files[0];if(!f)return;compress(f,d=>{fileData=d;document.getElementById('fileName').textContent='‚úì '+f.name;});}
function compress(file,cb){
  const r=new FileReader();
  r.onload=ev=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas');const ratio=Math.min(1,1400/img.width);c.width=img.width*ratio;c.height=img.height*ratio;c.getContext('2d').drawImage(img,0,0,c.width,c.height);cb(c.toDataURL('image/jpeg',0.82));};img.src=ev.target.result;};
  r.readAsDataURL(file);
}
const dzEl=document.getElementById('dz');
dzEl.addEventListener('dragover',e=>{e.preventDefault();dzEl.classList.add('over');});
dzEl.addEventListener('dragleave',()=>dzEl.classList.remove('over'));
dzEl.addEventListener('drop',e=>{e.preventDefault();dzEl.classList.remove('over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))compress(f,d=>{fileData=d;document.getElementById('fileName').textContent='‚úì '+f.name;});});

async function addImage(){
  const cats=[...document.querySelectorAll('.imgCat:checked')].map(c=>c.value);
  const note=document.getElementById('imgNote').value.trim();
  let src='';
  if(addTab==='url'){src=document.getElementById('imgUrl').value.trim();if(!src)return alert('Introduce URL v√°lida');}
  else{
    if(!fileData)return alert('Selecciona una imagen');
    src=fileData;
    if(accessToken&&rootFolderId){
      uploadImg(fileData,'img_'+Date.now()+'.jpg',S.active,cats).then(url=>{
        if(url){const im=I().find(i=>i._tmpSrc===fileData);if(im){im.driveSrc=url;save();}}
      });
    }
  }
  const vpr=cvp.getBoundingClientRect();
  const n=I().length;
  const cx=(-panX/zoomLevel)+(vpr.width/zoomLevel/2)-100+(n%5)*22;
  const cy=(-panY/zoomLevel)+(vpr.height/zoomLevel/2)-80+Math.floor(n/5)*22;
  const im={id:Date.now(),src,_tmpSrc:addTab==='file'?src:null,categories:cats.length?cats:['composicion'],keywords:[...addKws],note,x:Math.max(10,cx),y:Math.max(10,cy),w:200};
  I().push(im);save();closeModal('addModal');
  renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();updateCounts();renderPal();
}

// ‚îÄ‚îÄ KW INPUT ‚îÄ‚îÄ
function kwKey(e,inId,acId,list,pillsId){
  if(e.key===','){e.preventDefault();const v=e.target.value.replace(',','').trim();if(v&&!list.includes(v)){list.push(v);renderPills(list,pillsId);}e.target.value='';document.getElementById(acId).classList.remove('vis');}
}
function kwAc(inId,acId,list){
  const v=document.getElementById(inId).value.trim();const ac=document.getElementById(acId);
  if(!v){ac.classList.remove('vis');return;}
  const ms=allKws().filter(k=>k.toLowerCase().includes(v.toLowerCase())&&!list.includes(k));
  if(!ms.length){ac.classList.remove('vis');return;}
  const ln=list===addKws?'addKws':list===noteKws?'noteKws':list===editKws?'editKws':'editNoteKws';
  ac.classList.add('vis');
  ac.innerHTML=ms.slice(0,6).map(k=>`<div class="kwac-item" onclick="pickKw('${esc(k)}','${inId}','${acId}',${ln},'${pillsId}')">${esc(k)}</div>`).join('');
}
function pickKw(k,inId,acId,list,pillsId){if(!list.includes(k)){list.push(k);renderPills(list,pillsId);}document.getElementById(inId).value='';document.getElementById(acId).classList.remove('vis');}
function renderPills(list,pillsId){
  const c=document.getElementById(pillsId);if(!c)return;
  const ln=list===addKws?'addKws':list===noteKws?'noteKws':list===editKws?'editKws':'editNoteKws';
  c.innerHTML=list.map((k,i)=>`<div class="kwpill">${esc(k)}<span class="kwpill-x" onclick="rmPill(${i},'${pillsId}',${ln})">√ó</span></div>`).join('');
}
function rmPill(i,pillsId,list){list.splice(i,1);renderPills(list,pillsId);}

// ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ
let noteColor='sy',noteKws=[];
function selNC(el,cid){document.querySelectorAll('#'+cid+' .ncdot').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');if(cid==='noteModal')noteColor=el.dataset.c;else editNoteColorVal=el.dataset.c;}
function openNoteModal(){
  noteKws=[];noteColor='sy';
  document.getElementById('noteTxt').value='';document.getElementById('nkwIn').value='';document.getElementById('nkwPills').innerHTML='';
  document.querySelectorAll('.noteCat').forEach(c=>c.checked=false);
  document.querySelectorAll('#noteModal .ncdot').forEach(d=>d.classList.toggle('sel',d.dataset.c==='sy'));
  openModal('noteModal');
}
function addNote(){
  const text=document.getElementById('noteTxt').value.trim();if(!text)return;
  const cats=[...document.querySelectorAll('.noteCat:checked')].map(c=>c.value);
  const n={id:Date.now(),text,color:noteColor,categories:cats,keywords:[...noteKws],
    x:(-panX/zoomLevel)+80+Math.random()*300,y:(-panY/zoomLevel)+60+Math.random()*200,
    rot:Math.random()*8-4,anchored:false,anchorTo:null,_off:null};
  N().push(n);save();closeModal('noteModal');renderCanvas();renderKwCloud();updateCounts();
}

// ‚îÄ‚îÄ CANVAS RENDER ‚îÄ‚îÄ
function renderCanvas(){
  const canvas=document.getElementById('canvas');
  canvas.querySelectorAll('.icard,.sticky,.cel-title,.cel-box').forEach(el=>el.remove());
  const filt=hasFilter();
  const isEmpty=I().length===0&&N().length===0&&T().length===0&&B().length===0;
  document.getElementById('emptySt').style.display=isEmpty&&S.view==='canvas'?'flex':'none';
  B().forEach(b=>canvas.appendChild(makeBox(b)));
  T().forEach(t=>canvas.appendChild(makeTitle(t)));
  renderArrows();
  I().forEach(im=>{
    const card=makeImgCard(im);if(filt)card.classList.toggle('dim',!matches(im));canvas.appendChild(card);
    N().filter(n=>n.anchored&&n.anchorTo===im.id).forEach(n=>{const s=makeSticky(n);if(filt)s.classList.toggle('dim',!matches(n));canvas.appendChild(s);});
  });
  N().filter(n=>!n.anchored).forEach(n=>{const s=makeSticky(n);if(filt)s.classList.toggle('dim',!matches(n));canvas.appendChild(s);});
  updateSB();updateCounts();
}

// ‚îÄ‚îÄ IMAGE CARD ‚îÄ‚îÄ
function catCls(c){return{composicion:'hb-comp',iluminacion:'hb-luz',color:'hb-col'}[c]||'hb-comp';}
function catLbl(c){return{composicion:'Comp',iluminacion:'Luz',color:'Color'}[c]||c;}

function makeImgCard(im){
  const el=document.createElement('div');el.className='icard';el.dataset.id=im.id;
  el.style.cssText=`left:${im.x}px;top:${im.y}px;width:${im.w}px;z-index:${(im.id%40)+5}`;
  const h=Math.round(im.w*0.62);
  const catB=(im.categories||[]).map(c=>`<span class="hbadge ${catCls(c)}">${catLbl(c)}</span>`).join('');
  const kwB=(im.keywords||[]).map(k=>`<span class="hkw">${esc(k)}</span>`).join('');
  el.innerHTML=`
    <div class="icard-top"><div class="cpill">
      <button class="cpbtn" onclick="openEditImg(${im.id})">‚úé</button>
      <button class="cpbtn del" onclick="delImg(${im.id},event)">√ó</button>
    </div></div>
    <img class="icard-img" src="${im.src}" style="height:${h}px" alt=""
      onerror="this.style.background='var(--s2)';this.style.minHeight='50px'">
    <div class="icard-bot"><div class="icard-info">${catB}${kwB}${im.note?`<span style="font-size:8px;color:var(--t3);width:100%;font-family:'JetBrains Mono',monospace">${esc(im.note)}</span>`:''}</div></div>
    <div class="rh" data-id="${im.id}"></div>`;
  makeDrag(el,im);
  makeResize(el.querySelector('.rh'),el,im);
  el.addEventListener('dblclick',e=>{if(!e.target.classList.contains('cpbtn'))openEditImg(im.id);});
  return el;
}

function makeDrag(el,im){
  let sx,sy,sl,st,moved=false,drag=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('cpbtn')||e.target.classList.contains('rh')||e.button!==0||spaceDown||activeTool==='pan')return;
    drag=true;moved=false;el.classList.add('drag');
    sx=e.clientX;sy=e.clientY;sl=im.x;st=im.y;e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!drag)return;moved=true;
    im.x=Math.max(0,sl+(e.clientX-sx)/zoomLevel);
    im.y=Math.max(0,st+(e.clientY-sy)/zoomLevel);
    el.style.left=im.x+'px';el.style.top=im.y+'px';
    // Auto-anchor nearby free notes
    N().filter(n=>!n.anchored).forEach(n=>{
      const overlap=n.x<im.x+im.w&&n.x+185>im.x&&n.y<im.y+im.w*0.8&&n.y+80>im.y;
      if(overlap){
        // Visual hint
        const sel=document.querySelector(`.sticky[data-id="${n.id}"]`);
        if(sel)sel.style.outline='2px solid var(--acc)';
      }else{
        const sel=document.querySelector(`.sticky[data-id="${n.id}"]`);
        if(sel)sel.style.outline='';
      }
    });
    N().filter(n=>n.anchored&&n.anchorTo===im.id).forEach(n=>{
      if(n._off){n.x=im.x+n._off.dx;n.y=im.y+n._off.dy;}
      const s=document.querySelector(`.sticky[data-id="${n.id}"]`);if(s){s.style.left=n.x+'px';s.style.top=n.y+'px';}
    });
  });
  document.addEventListener('mouseup',()=>{
    if(drag){
      drag=false;el.classList.remove('drag');
      // Clear outlines
      document.querySelectorAll('.sticky').forEach(s=>s.style.outline='');
      if(moved)save();
    }
  });
}

function makeResize(handle,card,im){
  let sx,sw,r=false;
  handle.addEventListener('mousedown',e=>{r=true;sx=e.clientX;sw=im.w;e.stopPropagation();e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(!r)return;const nw=Math.max(120,sw+(e.clientX-sx)/zoomLevel);im.w=nw;card.style.width=nw+'px';card.querySelector('.icard-img').style.height=Math.round(nw*0.62)+'px';});
  document.addEventListener('mouseup',()=>{if(r){r=false;save();}});
}

// ‚îÄ‚îÄ STICKY NOTES ‚îÄ‚îÄ
function makeSticky(n){
  const el=document.createElement('div');el.className=`sticky ${n.color}`;el.dataset.id=n.id;
  el.style.cssText=`left:${n.x}px;top:${n.y}px;transform:rotate(${n.rot||0}deg);z-index:${n.anchored?45:55}`;
  const catInfo=(n.categories||[]).map(c=>`<span style="background:rgba(0,0,0,0.1);padding:1px 3px;border-radius:2px;font-size:8px">${c.substring(0,3)}</span>`).join('');
  const kwInfo=(n.keywords||[]).join(' ¬∑ ');
  el.innerHTML=`
    <div class="sticky-top"><div class="cpill">
      <button class="cpbtn" onclick="openEditNote(${n.id})">‚úé</button>
      <button class="cpbtn del" onclick="delNote(${n.id},event)">√ó</button>
    </div></div>
    <div class="sticky-inner"><div class="sticky-text">${esc(n.text)}</div></div>
    <div class="sticky-bot">${(n.categories||[]).length||(n.keywords||[]).length?`<div class="sticky-info">${catInfo}${kwInfo?`<span style="font-size:8px;opacity:0.5">${esc(kwInfo)}</span>`:''}</div>`:''}</div>`;
  // Auto-anchor: when dragged over an image, anchor it
  makeStickyDrag(el,n);
  el.addEventListener('dblclick',e=>{if(!e.target.classList.contains('cpbtn'))openEditNote(n.id);});
  return el;
}

function makeStickyDrag(el,n){
  let sx,sy,sl,st,drag=false,moved=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('cpbtn')||spaceDown||activeTool==='pan')return;
    drag=true;moved=false;el.classList.add('drag');
    // Temp un-anchor for dragging
    if(n.anchored){n.anchored=false;n.anchorTo=null;n._off=null;}
    sx=e.clientX;sy=e.clientY;sl=n.x;st=n.y;e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!drag)return;moved=true;
    n.x=Math.max(0,sl+(e.clientX-sx)/zoomLevel);
    n.y=Math.max(0,st+(e.clientY-sy)/zoomLevel);
    el.style.left=n.x+'px';el.style.top=n.y+'px';
    // Visual feedback for nearby images
    let found=false;
    I().forEach(im=>{
      const over=n.x<im.x+im.w&&n.x+185>im.x&&n.y<im.y+im.w*0.8&&n.y+80>im.y;
      const iel=document.querySelector(`.icard[data-id="${im.id}"]`);
      if(iel)iel.style.outline=over?'2px solid var(--acc)':'';
      if(over)found=true;
    });
    el.style.transform=`rotate(${found?0:n.rot||0}deg)`;
  });
  document.addEventListener('mouseup',()=>{
    if(drag){
      drag=false;el.classList.remove('drag');
      document.querySelectorAll('.icard').forEach(c=>c.style.outline='');
      // Auto-anchor if over an image
      let target=null;let minD=Infinity;
      I().forEach(im=>{
        const over=n.x<im.x+im.w&&n.x+185>im.x&&n.y<im.y+im.w*0.8&&n.y+80>im.y;
        if(over){const d=Math.hypot(n.x-im.x,n.y-im.y);if(d<minD){minD=d;target=im;}}
      });
      if(target){n.anchored=true;n.anchorTo=target.id;n._off={dx:n.x-target.x,dy:n.y-target.y};}
      else{n.anchored=false;el.style.transform=`rotate(${n.rot||0}deg)`;}
      if(moved)save();
    }
  });
}

function delNote(id,e){if(e)e.stopPropagation();S.notes[S.active]=N().filter(n=>n.id!==id);save();document.querySelector(`.sticky[data-id="${id}"]`)?.remove();updateCounts();renderKwCloud();}
function delImg(id,e){
  if(e){e.stopPropagation();e.preventDefault();}
  if(!confirm('¬øEliminar imagen?'))return;
  S.images[S.active]=I().filter(i=>i.id!==id);
  S.notes[S.active]=N().filter(n=>!(n.anchored&&n.anchorTo===id));
  save();renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();renderPal();updateCounts();
}

// ‚îÄ‚îÄ EDIT MODALS ‚îÄ‚îÄ
let editKws=[];
function openEditImg(id){
  const im=I().find(i=>i.id===id);if(!im)return;
  document.getElementById('eImgId').value=id;
  document.getElementById('eImgNote').value=im.note||'';
  document.querySelectorAll('.eCat').forEach(c=>c.checked=(im.categories||[]).includes(c.value));
  editKws=[...(im.keywords||[])];document.getElementById('ekwIn').value='';renderPills(editKws,'ekwPills');
  openModal('editImgModal');
}
function saveImgEdit(){
  const id=+document.getElementById('eImgId').value;const im=I().find(i=>i.id===id);if(!im)return;
  im.categories=[...document.querySelectorAll('.eCat:checked')].map(c=>c.value);
  if(!im.categories.length)im.categories=['composicion'];
  im.keywords=[...editKws];im.note=document.getElementById('eImgNote').value.trim();
  save();closeModal('editImgModal');renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();renderPal();
}
function delImgEdit(){const id=+document.getElementById('eImgId').value;if(!confirm('¬øEliminar imagen?'))return;S.images[S.active]=I().filter(i=>i.id!==id);S.notes[S.active]=N().filter(n=>!(n.anchored&&n.anchorTo===id));save();closeModal('editImgModal');renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();renderPal();updateCounts();}

let editNoteKws=[],editNoteColorVal='sy';
function openEditNote(id){
  const n=N().find(n=>n.id===id);if(!n)return;
  document.getElementById('eNoteId').value=id;document.getElementById('eNoteTxt').value=n.text;
  document.querySelectorAll('.eNoteCat').forEach(c=>c.checked=(n.categories||[]).includes(c.value));
  editNoteKws=[...(n.keywords||[])];editNoteColorVal=n.color;
  document.getElementById('enkwIn').value='';renderPills(editNoteKws,'enkwPills');
  document.querySelectorAll('#eNoteColors .ncdot').forEach(d=>d.classList.toggle('sel',d.dataset.c===n.color));
  openModal('editNoteModal');
}
function saveNoteEdit(){
  const id=+document.getElementById('eNoteId').value;const n=N().find(n=>n.id===id);if(!n)return;
  n.text=document.getElementById('eNoteTxt').value.trim();
  n.categories=[...document.querySelectorAll('.eNoteCat:checked')].map(c=>c.value);
  n.keywords=[...editNoteKws];n.color=editNoteColorVal;
  save();closeModal('editNoteModal');renderCanvas();if(S.view==='grid')renderGrid();renderKwCloud();
}
function delNoteEdit(){const id=+document.getElementById('eNoteId').value;closeModal('editNoteModal');delNote(id);}

// ‚îÄ‚îÄ CANVAS ELEMENTS ‚îÄ‚îÄ
function placeTitleClick(){
  cvp.style.cursor='crosshair';
  const h=e=>{
    if(e.target.closest('.ctb'))return;
    const rect=cvp.getBoundingClientRect();
    const x=(e.clientX-rect.left-panX)/zoomLevel;const y=(e.clientY-rect.top-panY)/zoomLevel;
    const t={id:Date.now(),text:'T√≠tulo',x:Math.max(0,x),y:Math.max(0,y)};
    T().push(t);save();document.getElementById('canvas').appendChild(makeTitle(t));
    cvp.style.cursor='';cvp.removeEventListener('click',h);setTool('select');
    setTimeout(()=>{const inp=document.querySelector(`.cel-title[data-id="${t.id}"]`);if(inp){const tx=inp.querySelector('.title-text');tx&&(tx.setAttribute('contenteditable','true'),tx.focus(),document.execCommand('selectAll',false,null));}},50);
  };
  cvp.addEventListener('click',h,{once:true});
}
function makeTitle(t){
  const el=document.createElement('div');el.className='cel-title';el.dataset.id=t.id;
  el.style.cssText=`left:${t.x}px;top:${t.y}px;z-index:25`;
  el.innerHTML=`<div class="title-ctrls"><div class="cpill"><button class="cpbtn del" onclick="delTitle(${t.id})">√ó</button></div></div><div class="title-text" contenteditable="true" spellcheck="false">${esc(t.text)}</div>`;
  const txt=el.querySelector('.title-text');
  txt.setAttribute('contenteditable','false'); // start non-editable
  el.addEventListener('dblclick',e=>{if(e.target.closest('.cpbtn'))return;txt.setAttribute('contenteditable','true');txt.focus();document.execCommand('selectAll',false,null);});
  txt.addEventListener('input',()=>{t.text=txt.textContent||'T√≠tulo';});
  txt.addEventListener('blur',()=>{txt.setAttribute('contenteditable','false');el.classList.remove('editing');save();});
  txt.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();txt.blur();}});
  // Click on text: if already editing, let it be. Otherwise let drag start on the wrapper
  txt.addEventListener('click',e=>{if(document.activeElement===txt)e.stopPropagation();});
  txt.addEventListener('focus',()=>el.classList.add('editing'));
  makeDragGen(el,t,txt);return el;
}
function delTitle(id){S.titles[S.active]=T().filter(t=>t.id!==id);save();document.querySelector(`.cel-title[data-id="${id}"]`)?.remove();}

let boxColorVal='#1a1a2e';
function selBCol(el){document.querySelectorAll('.bcol').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');boxColorVal=el.dataset.col;}
function placeBox(){
  const color=document.getElementById('boxCustom').value||boxColorVal;closeModal('boxModal');cvp.style.cursor='crosshair';
  const h=e=>{
    if(e.target.closest('.ctb'))return;
    const rect=cvp.getBoundingClientRect();
    const x=(e.clientX-rect.left-panX)/zoomLevel;const y=(e.clientY-rect.top-panY)/zoomLevel;
    const b={id:Date.now(),color,x:Math.max(0,x),y:Math.max(0,y),w:220,h:160};
    B().push(b);save();document.getElementById('canvas').appendChild(makeBox(b));cvp.style.cursor='';cvp.removeEventListener('click',h);setTool('select');
  };
  cvp.addEventListener('click',h,{once:true});
}
function makeBox(b){
  const el=document.createElement('div');el.className='cel-box';el.dataset.id=b.id;
  el.style.cssText=`left:${b.x}px;top:${b.y}px;width:${b.w}px;height:${b.h}px;background:${b.color};z-index:2`;
  el.innerHTML=`<div class="box-del"><div class="cpill"><button class="cpbtn del" onclick="delBox(${b.id})">√ó</button></div></div><div class="box-handles"><div class="bh tl" data-c="tl"></div><div class="bh tm" data-c="tm"></div><div class="bh tr" data-c="tr"></div><div class="bh ml" data-c="ml"></div><div class="bh mr" data-c="mr"></div><div class="bh bl" data-c="bl"></div><div class="bh bm" data-c="bm"></div><div class="bh br" data-c="br"></div></div>`;
  el.addEventListener('click',e=>{e.stopPropagation();document.querySelectorAll('.cel-box').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');});
  el.querySelectorAll('.bh').forEach(handle=>{
    let sx,sy,ox,oy,ow,oh,res=false;
    handle.addEventListener('mousedown',e=>{res=true;sx=e.clientX;sy=e.clientY;ox=b.x;oy=b.y;ow=b.w;oh=b.h;e.stopPropagation();e.preventDefault();});
    document.addEventListener('mousemove',e=>{
      if(!res)return;const dx=(e.clientX-sx)/zoomLevel,dy=(e.clientY-sy)/zoomLevel,c=handle.dataset.c;
      if(c.includes('r')){b.w=Math.max(80,ow+dx);}if(c.includes('l')){b.w=Math.max(80,ow-dx);b.x=ox+dx;}
      if(c.includes('b')){b.h=Math.max(60,oh+dy);}if(c.includes('t')){b.h=Math.max(60,oh-dy);b.y=oy+dy;}
      el.style.left=b.x+'px';el.style.top=b.y+'px';el.style.width=b.w+'px';el.style.height=b.h+'px';
    });
    document.addEventListener('mouseup',()=>{if(res){res=false;save();}});
  });
  makeDragGen(el,b,null);return el;
}
function delBox(id){S.boxes[S.active]=B().filter(b=>b.id!==id);save();document.querySelector(`.cel-box[data-id="${id}"]`)?.remove();}
document.getElementById('canvas').addEventListener('click',e=>{if(!e.target.closest('.cel-box')){document.querySelectorAll('.cel-box').forEach(b=>b.classList.remove('sel'));}});

function makeDragGen(el,obj,excludeEl){
  let sx,sy,sl,st,drag=false,moved=false;
  el.addEventListener('mousedown',e=>{
    if(e.button!==0||spaceDown||activeTool==='pan')return;
    if(e.target.classList.contains('cpbtn')||e.target.classList.contains('bh'))return;
    if(el.classList.contains('editing'))return;
    if(e.target.closest&&e.target.closest('[contenteditable]')&&document.activeElement===e.target)return;
    if(excludeEl&&(e.target===excludeEl||el.contains(excludeEl)&&e.target===excludeEl))return;
    drag=true;moved=false;el.classList.add('drag');
    sx=e.clientX;sy=e.clientY;sl=obj.x;st=obj.y;e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!drag)return;moved=true;
    obj.x=Math.max(0,sl+(e.clientX-sx)/zoomLevel);obj.y=Math.max(0,st+(e.clientY-sy)/zoomLevel);
    el.style.left=obj.x+'px';el.style.top=obj.y+'px';
  });
  document.addEventListener('mouseup',()=>{if(drag){drag=false;el.classList.remove('drag');if(moved)save();}});
}

// ‚îÄ‚îÄ ARROWS ‚îÄ‚îÄ
let arwDrawing=false,arwStart=null;
function startArrow(){
  cvp.style.cursor='crosshair';
  const down=e=>{if(e.target.closest('.ctb'))return;const rect=cvp.getBoundingClientRect();arwStart={x:(e.clientX-rect.left-panX)/zoomLevel,y:(e.clientY-rect.top-panY)/zoomLevel};arwDrawing=true;};
  const move=e=>{
    if(!arwDrawing)return;const rect=cvp.getBoundingClientRect();const ex=(e.clientX-rect.left-panX)/zoomLevel,ey=(e.clientY-rect.top-panY)/zoomLevel;
    const svg=document.getElementById('arrowSvg');let tmp=svg.querySelector('#tmpArr');
    if(!tmp){tmp=document.createElementNS('http://www.w3.org/2000/svg','line');tmp.id='tmpArr';tmp.setAttribute('stroke','#d4a85a');tmp.setAttribute('stroke-width','2');tmp.setAttribute('stroke-dasharray','6 3');tmp.setAttribute('marker-end','url(#ah)');svg.appendChild(tmp);}
    tmp.setAttribute('x1',arwStart.x);tmp.setAttribute('y1',arwStart.y);tmp.setAttribute('x2',ex);tmp.setAttribute('y2',ey);
  };
  const up=e=>{
    if(!arwDrawing)return;arwDrawing=false;document.getElementById('arrowSvg').querySelector('#tmpArr')?.remove();
    const rect=cvp.getBoundingClientRect();const ex=(e.clientX-rect.left-panX)/zoomLevel,ey=(e.clientY-rect.top-panY)/zoomLevel;
    if(Math.hypot(ex-arwStart.x,ey-arwStart.y)>15){AR().push({id:Date.now(),x1:arwStart.x,y1:arwStart.y,x2:ex,y2:ey});save();renderArrows();}
    cvp.style.cursor='';cvp.removeEventListener('mousedown',down);cvp.removeEventListener('mousemove',move);cvp.removeEventListener('mouseup',up);setTool('select');
  };
  cvp.addEventListener('mousedown',down);cvp.addEventListener('mousemove',move);cvp.addEventListener('mouseup',up);
}
function renderArrows(){
  const svg=document.getElementById('arrowSvg');svg.querySelectorAll('.arrow-el').forEach(el=>el.remove());
  AR().forEach(arr=>{
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');g.className.baseVal='arrow-el';
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',arr.x1);line.setAttribute('y1',arr.y1);line.setAttribute('x2',arr.x2);line.setAttribute('y2',arr.y2);
    line.setAttribute('stroke','#d4a85a');line.setAttribute('stroke-width','2');line.setAttribute('marker-end','url(#ah)');
    line.style.pointerEvents='stroke';line.style.cursor='pointer';
    line.addEventListener('dblclick',()=>{if(confirm('¬øEliminar flecha?')){S.arrows[S.active]=AR().filter(a=>a.id!==arr.id);save();renderArrows();}});
    [[arr,'x1','y1'],[arr,'x2','y2']].forEach(([a,xk,yk])=>{
      const h=document.createElementNS('http://www.w3.org/2000/svg','circle');
      h.setAttribute('cx',a[xk]);h.setAttribute('cy',a[yk]);h.setAttribute('r','7');
      h.setAttribute('fill','var(--s1)');h.setAttribute('stroke','#d4a85a');h.setAttribute('stroke-width','2');
      h.style.cursor='move';h.style.pointerEvents='all';h.style.opacity='0';
      g.addEventListener('mouseenter',()=>h.style.opacity='1');g.addEventListener('mouseleave',()=>h.style.opacity='0');
      let drag=false;
      h.addEventListener('mousedown',e=>{drag=true;e.stopPropagation();e.preventDefault();});
      document.addEventListener('mousemove',e=>{if(!drag)return;const rect=cvp.getBoundingClientRect();a[xk]=(e.clientX-rect.left-panX)/zoomLevel;a[yk]=(e.clientY-rect.top-panY)/zoomLevel;line.setAttribute('x1',arr.x1);line.setAttribute('y1',arr.y1);line.setAttribute('x2',arr.x2);line.setAttribute('y2',arr.y2);h.setAttribute('cx',a[xk]);h.setAttribute('cy',a[yk]);});
      document.addEventListener('mouseup',()=>{if(drag){drag=false;save();}});
      g.appendChild(h);
    });
    g.appendChild(line);svg.appendChild(g);
  });
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ
function renderGrid(){
  const con=document.getElementById('gmas');con.innerHTML='';
  const filt=hasFilter();
  const showImgs=gridTab==='all'||gridTab==='images';
  const showNotes=gridTab==='all'||gridTab==='notes';

  if(showNotes){
    N().filter(n=>!n.anchored&&(!filt||matches(n))).forEach(n=>{
      const el=document.createElement('div');el.className=`gfree-note ${n.color}`;
      el.innerHTML=esc(n.text);el.ondblclick=()=>openEditNote(n.id);con.appendChild(el);
    });
  }
  if(showNotes&&gridTab==='notes'){
    // Show all notes including anchored
    N().filter(n=>n.anchored&&(!filt||matches(n))).forEach(n=>{
      const el=document.createElement('div');el.className=`gnote-standalone ${n.color}`;
      el.innerHTML=esc(n.text);el.ondblclick=()=>openEditNote(n.id);con.appendChild(el);
    });
  }
  if(showImgs){
    I().filter(im=>!filt||matches(im)).forEach(im=>{
      const frag=document.createElement('div');frag.style.cssText='break-inside:avoid;margin-bottom:5px;';
      if(showNotes)N().filter(n=>n.anchored&&n.anchorTo===im.id).forEach(n=>{const ne=document.createElement('div');ne.className=`gnote-above ${n.color}`;ne.textContent=n.text;frag.appendChild(ne);});
      const catB=(im.categories||[]).map(c=>`<span class="hbadge ${catCls(c)}">${catLbl(c)}</span>`).join('');
      const kwB=(im.keywords||[]).map(k=>`<span class="hkw">${esc(k)}</span>`).join('');
      const card=document.createElement('div');card.className='gcard';
      card.innerHTML=`<img src="${im.src}" alt="" loading="lazy" onerror="this.style.height='40px';this.style.background='var(--s2)'">
        <div class="gcard-ov"><div class="gcard-acts">
          <button class="ga-btn" onclick="openLB(${im.id})">üîç</button>
          <button class="ga-btn" onclick="openEditImg(${im.id})">‚úé</button>
          <button class="ga-btn" onclick="delImg(${im.id},event)" style="background:rgba(255,80,80,0.92)">√ó</button>
        </div></div>
        <div class="gcard-meta">${catB}${kwB}</div>
        ${im.note?`<div class="gcard-note">${esc(im.note)}</div>`:''}`;
      card.addEventListener('click',e=>{if(!e.target.closest('.ga-btn'))openLB(im.id);});
      card.addEventListener('dblclick',e=>{e.stopPropagation();openEditImg(im.id);});
      frag.appendChild(card);con.appendChild(frag);
    });
  }
}
function openLB(id){const im=I().find(i=>i.id==id);if(!im)return;const lb=document.createElement('div');lb.className='lbox';lb.innerHTML=`<button class="lbox-close" onclick="this.closest('.lbox').remove()">√ó</button><img src="${im.src}" alt="">`;lb.addEventListener('click',e=>{if(e.target===lb)lb.remove();});document.body.appendChild(lb);}

// ‚îÄ‚îÄ PALETTE ‚îÄ‚îÄ
function togglePal(){const c=document.getElementById('palContent');const t=document.getElementById('palTog');const open=c.style.display==='none';c.style.display=open?'':'none';t.textContent=open?'‚ñæ ocultar':'‚ñ∏ ver';if(open)renderPal();}
function renderPal(){
  const ent=document.getElementById('palEntries');const colorImgs=I().filter(im=>(im.categories||[]).includes('color'));
  if(!colorImgs.length){ent.innerHTML='<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">A√±ade imgs en categor√≠a Color</span>';return;}
  ent.innerHTML=colorImgs.map(im=>`<div class="palentry"><img src="${im.src}" class="palthumb" id="pt${im.id}" crossorigin="anonymous"><div class="palswatches" id="ps${im.id}"></div></div>`).join('');
  colorImgs.forEach(im=>{const img=document.getElementById(`pt${im.id}`);if(!img)return;const go=()=>{try{const c=document.createElement('canvas');c.width=40;c.height=40;c.getContext('2d').drawImage(img,0,0,40,40);const px=c.getContext('2d').getImageData(0,0,40,40).data;const s=document.getElementById(`ps${im.id}`);if(s)s.innerHTML=sampleColors(px,5).map(([r,g,b])=>`<div class="pswatch" style="background:rgb(${r},${g},${b})" onclick="navigator.clipboard&&navigator.clipboard.writeText('rgb(${r},${g},${b})')"></div>`).join('');}catch(e){}};img.onload=go;if(img.complete)go();});
}
function sampleColors(px,n){const b={};for(let i=0;i<px.length;i+=12){const r=Math.round(px[i]/40)*40,g=Math.round(px[i+1]/40)*40,bl=Math.round(px[i+2]/40)*40;const k=`${r},${g},${bl}`;b[k]=(b[k]||0)+1;}return Object.entries(b).sort((a,c)=>c[1]-a[1]).slice(0,n).map(([k])=>k.split(',').map(Number));}

// ‚îÄ‚îÄ IO ‚îÄ‚îÄ
let expOpt='db';
function openIO(){openModal('ioModal');switchIO('export');}
function switchIO(t){document.getElementById('ioExportSec').style.display=t==='export'?'':'none';document.getElementById('ioImportSec').style.display=t==='import'?'':'none';document.getElementById('ioExp').classList.toggle('active',t==='export');document.getElementById('ioImp').classList.toggle('active',t==='import');}
function selExpOpt(o){expOpt=o;document.querySelectorAll('.expopt').forEach(el=>el.classList.remove('sel'));document.getElementById('expOpt'+o.charAt(0).toUpperCase()+o.slice(1)).classList.add('sel');}
function doExport(){
  let out={};
  if(expOpt==='db'||expOpt==='all'){
    out.projects=S.projects;out.active=S.active;out.notes=S.notes;out.titles=S.titles;out.boxes=S.boxes;out.arrows=S.arrows;
    // DB without large base64 images
    if(expOpt==='db'){
      const imgs={};Object.keys(S.images).forEach(p=>{imgs[p]=(S.images[p]||[]).map(im=>({...im,src:im.driveSrc||im.src.substring(0,100)+'...(local)'}));});
      out.images=imgs;
    }else{out.images=S.images;}
  }else if(expOpt==='img'){
    out.images=S.images;out.projects=S.projects;
  }
  const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`frame_${S.active}_${expOpt}_${Date.now()}.json`;a.click();
}
function doImport(){
  try{
    const p=JSON.parse(document.getElementById('importJson').value);
    ['projects','images','notes','titles','boxes','arrows'].forEach(k=>{if(p[k])S[k]=p[k];});
    if(p.active)S.active=p.active;
    save();closeModal('ioModal');renderAll();
  }catch(e){alert('JSON inv√°lido');}
}

// ‚îÄ‚îÄ CONTACT SHEET ‚îÄ‚îÄ
function openContactSheet(){
  document.getElementById('csTitle').value='Frame ‚Äî '+S.active+' ‚Äî Referentes visuales';
  updateCSPreview();openModal('csModal');
  document.querySelectorAll('#csModal input,#csModal select').forEach(el=>el.addEventListener('change',updateCSPreview));
}
function getCsImgs(){
  const cats=[...document.querySelectorAll('.csCat:checked')].map(c=>c.value);
  const kwRaw=document.getElementById('csKwFilter').value.trim();
  const kws=kwRaw?kwRaw.split(',').map(k=>k.trim()).filter(Boolean):[];
  return I().filter(im=>{
    const catOk=cats.length===0||(im.categories||[]).some(c=>cats.includes(c));
    const kwOk=kws.length===0||kws.some(k=>(im.keywords||[]).some(ik=>ik.toLowerCase().includes(k.toLowerCase())));
    return catOk&&kwOk;
  });
}
function updateCSPreview(){
  const imgs=getCsImgs();const prev=document.getElementById('csPreview');const cnt=document.getElementById('csCount');
  prev.innerHTML=imgs.slice(0,20).map(im=>`<img src="${im.src}" class="cs-thumb" onerror="this.style.display='none'">`).join('');
  cnt.textContent=imgs.length+' imagen'+( imgs.length!==1?'es':'')+' seleccionada'+(imgs.length!==1?'s':'')+(imgs.length>20?' (mostrando 20)':'');
}
async function generateContactSheet(){
  const imgs=getCsImgs();if(!imgs.length){alert('No hay im√°genes que coincidan con el filtro.');return;}
  const {jsPDF}=window.jspdf;
  const fmt=document.getElementById('csFmt').value;
  const orient=document.getElementById('csOrient').value;
  const cols=parseInt(document.getElementById('csCols').value)||4;
  const rows=parseInt(document.getElementById('csRows').value)||5;
  const showNote=document.getElementById('csShowNote').checked;
  const showKw=document.getElementById('csShowKw').checked;
  const title=document.getElementById('csTitle').value||'Frame';
  const doc=new jsPDF({orientation:orient,unit:'mm',format:fmt});
  const W=orient==='landscape'?(fmt==='a3'?420:297):(fmt==='a3'?297:210);
  const H=orient==='landscape'?(fmt==='a3'?297:210):(fmt==='a3'?420:297);
  const margin=12,gap=4,headerH=14;
  const cellW=(W-margin*2-gap*(cols-1))/cols;
  const noteH=showNote||showKw?8:0;
  const cellH=(H-margin*2-headerH-gap*(rows-1))/rows-noteH;
  let page=0,col=0,row=0;
  const drawHeader=()=>{
    doc.setFillColor(248,246,242);doc.rect(0,0,W,headerH,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(11);doc.setTextColor(30,25,15);
    doc.text(title,margin,9);
    doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(140);
    doc.text(new Date().toLocaleDateString('es-ES')+' ¬∑ '+imgs.length+' referencias ¬∑ Frame v6',W-margin,9,{align:'right'});
  };
  drawHeader();
  for(const im of imgs){
    const x=margin+col*(cellW+gap);const y=headerH+margin+row*(cellH+noteH+gap);
    // Image
    doc.setFillColor(235,233,228);doc.roundedRect(x,y,cellW,cellH,1,1,'F');
    if(im.src.startsWith('data:')){
      try{doc.addImage(im.src,'JPEG',x,y,cellW,cellH,undefined,'FAST');}catch(e){}
    }
    // Note / keywords
    if(showNote&&im.note){doc.setFont('helvetica','normal');doc.setFontSize(5.5);doc.setTextColor(80);const lines=doc.splitTextToSize(im.note,cellW);doc.text(lines.slice(0,1),x,y+cellH+4);}
    if(showKw&&(im.keywords||[]).length){doc.setFont('helvetica','italic');doc.setFontSize(5);doc.setTextColor(140);doc.text(im.keywords.slice(0,4).join(', '),x,y+cellH+(showNote&&im.note?7:4),{maxWidth:cellW});}
    col++;
    if(col>=cols){col=0;row++;if(row>=rows){row=0;page++;doc.addPage();doc.setFillColor(255,255,255);doc.rect(0,0,W,H,'F');drawHeader();}}
  }
  doc.save(`frame_hoja_contactos_${fmt}_${orient}.pdf`);
  closeModal('csModal');
}

// ‚îÄ‚îÄ COUNTS & STATUS ‚îÄ‚îÄ
function updateCounts(){document.getElementById('fc-all').textContent=I().length;['composicion','iluminacion','color'].forEach(c=>{const el=document.getElementById('fc-'+c);if(el)el.textContent=I().filter(im=>(im.categories||[]).includes(c)).length;});}
function updateSB(){document.getElementById('sbProj').textContent='üìÅ '+S.active;document.getElementById('sbImgs').textContent=I().length+' imgs';document.getElementById('sbNotes').textContent=N().length+' notas';}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function openModal(id){document.getElementById(id).style.display='flex';}
function closeModal(id){document.getElementById(id).style.display='none';}
document.querySelectorAll('.mbg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.style.display='none';}));
function setLoader(show,msg){document.getElementById('loader').style.display=show?'flex':'none';if(msg)document.getElementById('loaderMsg').textContent=msg;}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ
function renderAll(){renderProjBar();if(S.view==='canvas')renderCanvas();else renderGrid();renderKwCloud();updateCounts();updateFilterUI();updateSB();applyTrans();}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.onload=()=>{
  try{
    const saved=localStorage.getItem('frame_v6');
    if(saved){const p=JSON.parse(saved);['projects','images','notes','titles','boxes','arrows'].forEach(k=>{if(p[k])S[k]=p[k];});if(p.active)S.active=p.active;if(p.theme){S.theme=p.theme;document.documentElement.dataset.theme=p.theme;}if(p.filter)S.filter=p.filter;if(p.view)S.view=p.view;}
  }catch(e){}
  const s=document.createElement('script');s.src='https://accounts.google.com/gsi/client';
  s.onload=()=>{initDrive();setLoader(false);renderAll();};
  s.onerror=()=>{setLoader(false);renderAll();};
  document.head.appendChild(s);
};
</script></body></html>
